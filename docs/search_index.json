[
["microbiota.html", "3 Microbiota 3.1 OTU table overview 3.2 Alpha diversity 3.3 Beta diversity 3.4 Environmental modelling 3.5 Relative abundances 3.6 Depth response: OTU perspective 3.7 Sequence similarity 3.8 Phylogeny", " 3 Microbiota 3.1 OTU table overview Let’s start by taking a look at the OTU table and get an overall impression of our data. library(tidyverse) library(reshape2) library(stringr) library(ggplot2) library(RColorBrewer) library(forcats) library(kableExtra) options(kableExtra.html.bsTable = T) library(gridExtra) library(DT) library(vegan) library(phyloseq) library(picante) library(seqinr) library(gtools) # install.packages(&#39;webshot&#39;) webshot::install_phantomjs() microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) # meta_data &lt;- meta_data[!str_sub(meta_data$unified_ID,1,2)==&#39;QC&#39;,] # remove QC # samples meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] microbiome &lt;- microbiome[order(microbiome$Sample_ID), ] meta_data &lt;- meta_data[order(meta_data$unified_ID), ] # dropping factors from full data: meta_data[] &lt;- lapply(meta_data, function(x) if (is.factor(x)) factor(x) else x) microbiome[] &lt;- lapply(microbiome, function(x) if (is.factor(x)) factor(x) else x) # all(meta_data$unified_ID==microbiome$Sample_ID) rownames(microbiome) &lt;- microbiome[, 1] microbiome[, 1] &lt;- NULL microbiome[&quot;total_OTUs&quot;] &lt;- apply(microbiome, 1, sum) #total_OTUs = Cummulative read count micro_fig1 &lt;- data.frame(microbiome[, &quot;total_OTUs&quot;]) micro_fig1[&quot;unified_ID&quot;] &lt;- rownames(microbiome) micro_fig1[&quot;normalisation&quot;] &lt;- &quot;none&quot; microbiome$total_OTUs &lt;- NULL microbiome &lt;- sqrt(microbiome) microbiome[&quot;total_OTUs&quot;] &lt;- apply(microbiome, 1, sum) micro_fig2 &lt;- data.frame(microbiome[, &quot;total_OTUs&quot;]) micro_fig2[&quot;unified_ID&quot;] &lt;- rownames(microbiome) micro_fig2[&quot;normalisation&quot;] &lt;- &quot;sqrt&quot; microbiome$total_OTUs &lt;- NULL microbiome &lt;- wisconsin(microbiome) microbiome[&quot;total_OTUs&quot;] &lt;- apply(microbiome, 1, sum) micro_fig3 &lt;- data.frame(microbiome[, &quot;total_OTUs&quot;]) micro_fig3[&quot;unified_ID&quot;] &lt;- rownames(microbiome) micro_fig3[&quot;normalisation&quot;] &lt;- &quot;sqrt wisconsin&quot; micro_fig &lt;- rbind(micro_fig1, micro_fig2, micro_fig3) colnames(micro_fig) &lt;- c(&quot;total_OTUs&quot;, &quot;unified_ID&quot;, &quot;normalisation&quot;) micro_fig[&quot;Species&quot;] &lt;- str_sub(micro_fig$unified_ID, 1, 2) ggplot(micro_fig, aes(x = unified_ID, y = total_OTUs)) + geom_bar(stat = &quot;identity&quot;) + facet_grid(vars(normalisation), vars(Species), scales = &quot;free&quot;) + xlab(&quot;Samples&quot;) + ylab(&quot;Number of OTUs&quot;) + ggtitle(&quot;Cummulative read count after normalisation&quot;) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) Figure 3.1: Read count overview of the OTU table before and after the normalisation applied in the data analysis for this study. # see # https://chrischizinski.github.io/SNR_R_Group/2016-08-10-Data-Transformations Do the normalisations have affect how well we can discriminate between the microbiota? microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] rownames(microbiome) &lt;- microbiome[, 1] microbiome[, 1] &lt;- NULL pca_plot &lt;- function(microbiome, meta_data, my_title) { micro.pca &lt;- prcomp(microbiome, scale = T) k &lt;- summary(micro.pca)[[&quot;importance&quot;]] micro_pca_df &lt;- data.frame(micro.pca$x) #scores, i.e. principal components of the sponge sample micro_pca_df[&quot;unified_ID&quot;] &lt;- as.factor(rownames(micro_pca_df)) x1 &lt;- paste(&quot;PC1&quot;, round(k[2, 1], digits = 3) * 100, &quot;%&quot;) y1 &lt;- paste(&quot;PC2&quot;, round(k[2, 2], digits = 3) * 100, &quot;%&quot;) micro_pca_df &lt;- left_join(micro_pca_df[, c(&quot;PC1&quot;, &quot;PC2&quot;, &quot;PC3&quot;, &quot;unified_ID&quot;)], meta_data[, c(&quot;Species&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;unified_ID&quot;)]) p &lt;- ggplot(micro_pca_df, aes(x = PC1, y = PC2)) + geom_point(size = 3, mapping = aes(shape = factor(Species))) + ggtitle(my_title) + xlab(x1) + ylab(y1) + labs(shape = &quot;Species&quot;) + theme_bw() + theme(legend.position = &quot;none&quot;) return(p) } untransformed &lt;- pca_plot(microbiome, meta_data, &quot;untransformed&quot;) sqrt_transformed &lt;- pca_plot(sqrt(microbiome), meta_data, &quot;sqrt&quot;) sqrt_wisc_transformed &lt;- pca_plot(wisconsin(sqrt(microbiome)), meta_data, &quot;sqrt and wisconsin&quot;) grid.arrange(untransformed, sqrt_transformed, sqrt_wisc_transformed, nrow = 1, top = &quot;PCA: Impact of normalisation on discrimination of the microbiota&quot;) Figure 3.2: PCA of the data sets with and without transformation/normalisation. Circles are Gb, triangles are Sf, squares are Wb microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] rownames(microbiome) &lt;- microbiome[, 1] microbiome[, 1] &lt;- NULL nmds_plot &lt;- function(microbiome, meta_data, my_title) { micro.mds &lt;- metaMDS(microbiome, k = 2, trymax = 100, distance = &quot;bray&quot;, trace = FALSE) nmds_points &lt;- as.data.frame(micro.mds$points) samples &lt;- data.frame(nmds_points$MDS1, nmds_points$MDS2) samples[&quot;unified_ID&quot;] &lt;- rownames(microbiome) meta_data &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;, &quot;Species&quot;)] samples &lt;- left_join(samples, meta_data) stress &lt;- paste(&quot;Stress=&quot;, round(micro.mds$stress, digits = 3)) p &lt;- ggplot(samples, aes(x = nmds_points.MDS1, y = nmds_points.MDS2)) + geom_point(aes(shape = Species, alpha = 0.5), size = 4) + ggtitle(my_title) + labs(shape = &quot;Sponge species&quot;) + theme_bw() + theme(legend.position = &quot;none&quot;) + xlab(&quot;NMDS 1&quot;) + ylab(&quot;NMDS 2&quot;) + annotate(&quot;text&quot;, x = 0, y = 1, label = stress) return(p) } untransformed &lt;- nmds_plot(microbiome, meta_data, &quot;untransformed&quot;) sqrt_transformed &lt;- nmds_plot(sqrt(microbiome), meta_data, &quot;sqrt&quot;) sqrt_wisc_transformed &lt;- nmds_plot(wisconsin(sqrt(microbiome)), meta_data, &quot;sqrt and wisconsin&quot;) grid.arrange(untransformed, sqrt_transformed, sqrt_wisc_transformed, nrow = 1, top = &quot;NMDS: Impact of normalisation on discrimination of the microbiota&quot;) Figure 3.3: NMDS of the data sets with and without transformation/normalisation. Circles are Gb, triangles are Sf, squares are Wb It seems that we don’t lose any relevant information and the normalisations in fact increase the discriminatory power. 3.2 Alpha diversity The microbiota are composed of 420 OTUs in G. barretti, 461 OTUs in S. fortis and 135 OTUs in W. bursa. While G. barretti and S. fortis share 316, respectively they each only share 2 and 8 OTUs with W. bursa. Only a single OTU (OTU4 or X1969004, an Archaeon) is shared among the three sponge hosts. How does that reflect in their diversities? Below we show Shannon diversity, species richness (SR) and Faith’s phylogenetic distance (PD). library(vegan) library(reshape2) library(phyloseq) library(picante) microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) taxonomy &lt;- read.csv(&quot;data/microbiome_taxonomy.csv&quot;, header = T, sep = &quot;;&quot;) tree &lt;- read.nexus(&quot;data/infile.nex.con.X.tre&quot;) rownames(microbiome) &lt;- microbiome$Sample_ID microbiome$Sample_ID &lt;- NULL otumat &lt;- t(microbiome) otumat &lt;- wisconsin(sqrt(otumat)) colnames(otumat) &lt;- rownames(microbiome) rownames(taxonomy) &lt;- paste0(&quot;X&quot;, taxonomy$OTU_ID) taxonomy$OTU_ID &lt;- NULL # all(rownames(taxonomy)==rownames(otumat)) # relative abundance otumat &lt;- apply(otumat, 2, function(i) i/sum(i)) OTU &lt;- otu_table(otumat, taxa_are_rows = TRUE) # remove low abundance taxa OTU &lt;- filter_taxa(OTU, function(x) mean(x) &gt; 0.0025, # TRUE) taxmat &lt;- as.matrix(taxonomy) TAX &lt;- tax_table(taxmat) biom_data &lt;- phyloseq(OTU, TAX) # Merge into phyloseq object pso &lt;- merge_phyloseq(biom_data, tree) #merging a phyloseq and a tree file pso &lt;- prune_taxa(taxa_sums(pso) &gt; 0, pso) # Calculate Phylogenetic Distance (PD) of the dataset, ALPHA DIVERSITY otu_table_pso &lt;- as.data.frame(pso@otu_table) df.pd &lt;- pd(t(otu_table_pso), tree, include.root = F) df.pd[&quot;unified_ID&quot;] &lt;- rownames(df.pd) # df.pd: PD = Faith&#39;s Phylogenetic diversity, SR= species richness div &lt;- as.data.frame(diversity(t(otumat), index = &quot;shannon&quot;)) div[&quot;spec&quot;] &lt;- str_sub(rownames(div), 1, 2) colnames(div) &lt;- c(&quot;Shannon_diversity&quot;, &quot;spec&quot;) div[&quot;unified_ID&quot;] &lt;- rownames(div) div_indices &lt;- full_join(div, df.pd) md &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;)] div_indices &lt;- left_join(div_indices, md) div_indices &lt;- reshape2::melt(div_indices, id.vars = c(&quot;spec&quot;, &quot;unified_ID&quot;, &quot;Depth&quot;)) ggplot(div_indices, aes(x = Depth, y = value)) + geom_point() + facet_grid(vars(variable), vars(spec), scales = &quot;free&quot;) + theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 1), legend.position = &quot;none&quot;) + ylab(&quot;Diversity metrics&quot;) + xlab(&quot;Sample depth&quot;) + theme_bw() Figure 3.4: Microbiota diversity indices grouped by sponge species and ordered by sample depth. We see that the HMA sponges G. barretti and S. fortis not only have more OTUs but also a higher diversity in their prokaryotic communities then the LMA sponge W. bursa. 3.3 Beta diversity In a way, the Fig. 3.2 and 3.3 have already shown us the beta diversity in our samples. Looking more into the data, we found that the two dimensional representation can be misleading at times and so we provide the first three axes components for exploration below. library(plot3D) library(rgl) library(plotly) ### PCA microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] rownames(microbiome) &lt;- microbiome[, 1] microbiome[, 1] &lt;- NULL microbiome &lt;- sqrt(microbiome) micro.pca &lt;- prcomp(microbiome, scale = T) k &lt;- summary(micro.pca)[[&quot;importance&quot;]] micro_pca_df &lt;- data.frame(micro.pca$x) #scores, i.e. principal components of the sponge sample micro_pca_df[&quot;unified_ID&quot;] &lt;- as.factor(rownames(micro_pca_df)) x1 &lt;- paste(&quot;PC1&quot;, round(k[2, 1], digits = 3) * 100, &quot;%&quot;) y1 &lt;- paste(&quot;PC2&quot;, round(k[2, 2], digits = 3) * 100, &quot;%&quot;) z1 &lt;- paste(&quot;PC3&quot;, round(k[2, 3], digits = 3) * 100, &quot;%&quot;) micro_pca_df &lt;- left_join(micro_pca_df[, c(&quot;PC1&quot;, &quot;PC2&quot;, &quot;PC3&quot;, &quot;unified_ID&quot;)], meta_data[, c(&quot;Species&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;unified_ID&quot;)]) # ggplot(micro_pca_df, aes(x=PC1, y=PC2))+geom_point(size=3, # mapping=aes(shape=factor(Species), # col=Depth))+ggtitle(my_title)+xlab(x1)+ylab(y1)+labs(shape=&#39;Species&#39;)+theme_bw()+theme(legend.position # = &#39;none&#39;) ## rgl/plot3D with(micro_pca_df, text3D(PC1, PC2, PC3, colvar = micro_pca_df$Depth, theta = 60, phi = 20, xlab = x1, ylab = y1, zlab = z1, main = &quot;3D microbiome PCA&quot;, labels = micro_pca_df$unified_ID, cex = 0.9, bty = &quot;g&quot;, ticktype = &quot;detailed&quot;, d = 2, clab = c(&quot;Depth [m]&quot;), adj = 0.5, font = 2)) Figure 3.5: PCA of the met ## plotly axx &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = x1, showbackground = TRUE) axy &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = y1, showbackground = TRUE) axz &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = z1, showbackground = TRUE) mic_i &lt;- plot_ly(micro_pca_df, x = ~micro_pca_df$PC1, y = ~micro_pca_df$PC2, z = ~micro_pca_df$PC3, symbol = ~Species, symbols = c(&quot;diamond&quot;, &quot;x&quot;, &quot;circle&quot;), color = ~micro_pca_df$Depth) %&gt;% add_markers() %&gt;% layout(scene = list(xaxis = axx, yaxis = axy, zaxis = axz)) mic_i Figure 3.5: PCA of the met f &lt;- basename(tempfile(&quot;PCA_microbiome_plotly&quot;, &quot;.&quot;, &quot;.html&quot;)) on.exit(unlink(f), add = TRUE) html &lt;- htmlwidgets::saveWidget(mic_i, f) library(plot3D) library(rgl) library(plotly) ### PCA microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] rownames(microbiome) &lt;- microbiome[, 1] microbiome[, 1] &lt;- NULL micro.pca &lt;- prcomp(microbiome, scale = T) k &lt;- summary(micro.pca)[[&quot;importance&quot;]] micro_pca_df &lt;- data.frame(micro.pca$x) #scores, i.e. principal components of the sponge sample micro_pca_df[&quot;unified_ID&quot;] &lt;- as.factor(rownames(micro_pca_df)) x1 &lt;- paste(&quot;PC1&quot;, round(k[2, 1], digits = 3) * 100, &quot;%&quot;) y1 &lt;- paste(&quot;PC2&quot;, round(k[2, 2], digits = 3) * 100, &quot;%&quot;) z1 &lt;- paste(&quot;PC3&quot;, round(k[2, 3], digits = 3) * 100, &quot;%&quot;) micro_pca_df &lt;- left_join(micro_pca_df[, c(&quot;PC1&quot;, &quot;PC2&quot;, &quot;PC3&quot;, &quot;unified_ID&quot;)], meta_data[, c(&quot;Species&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;unified_ID&quot;)]) # ggplot(micro_pca_df, aes(x=PC1, y=PC2))+geom_point(size=3, # mapping=aes(shape=factor(Species), # col=Depth))+ggtitle(my_title)+xlab(x1)+ylab(y1)+labs(shape=&#39;Species&#39;)+theme_bw()+theme(legend.position # = &#39;none&#39;) # with(micro_pca_df, scatter3D(x = PC1, y = PC2, z = -PC3, colvar # =micro_pca_df$Depth, pch = 16, cex = 1.5, xlab =x1, ylab =y1, zlab =z1, clab = # c(&#39;Depth&#39;,&#39;m&#39;), main = &#39;3D microbiome PCA&#39;, ticktype = &#39;detailed&#39;, theta = 10, # d = 2, colkey = list(length = 0.5, width = 0.5, cex.clab = 0.75))) # ks1 scatter3D(x=micro_pca_df$PC1, y=micro_pca_df$PC2, micro_pca_df$PC3) #works # crude #KEEP scatter3D(x=micro_pca_df$PC1, y=micro_pca_df$PC2, micro_pca_df$PC3, # phi = 0, bty = &#39;g&#39;,pch = 20, cex = 2, ticktype = &#39;detailed&#39;) # scatter3D(x=micro_pca_df$PC1, y=micro_pca_df$PC2, micro_pca_df$PC3, phi = 0, # labels = micro_pca_df$unified_ID, bty = &#39;g&#39;,pch = 20, cex = 2, ticktype = # &#39;detailed&#39;,colvar = micro_pca_df$Depth) # rgl/plot3D with(micro_pca_df, text3D(PC1, PC2, PC3, colvar = micro_pca_df$Depth, theta = 60, phi = 20, xlab = x1, ylab = y1, zlab = z1, main = &quot;3D microbiome PCA&quot;, labels = micro_pca_df$unified_ID, cex = 0.9, bty = &quot;g&quot;, ticktype = &quot;detailed&quot;, d = 2, clab = c(&quot;Depth [m]&quot;), adj = 0.5, font = 2)) ## plotly axx &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = x1, showbackground = TRUE) axy &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = y1, showbackground = TRUE) axz &lt;- list(backgroundcolor = &quot;rgb(211,211,211)&quot;, gridcolor = &quot;rgb(255,255,255)&quot;, title = z1, showbackground = TRUE) mic_i &lt;- plot_ly(micro_pca_df, x = ~micro_pca_df$PC1, y = ~micro_pca_df$PC2, z = ~micro_pca_df$PC3, symbol = ~Species, symbols = c(&quot;diamond&quot;, &quot;x&quot;, &quot;circle&quot;), color = ~micro_pca_df$Depth) %&gt;% add_markers() %&gt;% layout(scene = list(xaxis = axx, yaxis = axy, zaxis = axz)) mic_i f &lt;- basename(tempfile(&quot;PCA_microbiome_plotly&quot;, &quot;.&quot;, &quot;.html&quot;)) on.exit(unlink(f), add = TRUE) html &lt;- htmlwidgets::saveWidget(mic_i, f) In some of the downstream analyses, we distinguish between common/abundant OTUs and rare OTUs. We use a cutoff of 0.25% average relative abundance per OTU for the classification. That implies drastically modifying the original numbers of OTUs per sponge as outlined below. micro &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) emp &lt;- read.csv(&quot;data/SpongeEMP.csv&quot;, header = T, sep = &quot;;&quot;) emp[&quot;XOTU_id&quot;] &lt;- str_replace(emp$OTU_ID, &quot;OTU&quot;, &quot;X196900&quot;) # The full data set had the entries listed by sponge host, so there are 62 # duplicates in the OTU list length(emp$XOTU_id) # 207 # length(unique(emp$XOTU_id)) # 145 emp[&quot;num&quot;] &lt;- as.numeric(str_replace(emp$OTU_ID, &quot;OTU&quot;, &quot;&quot;)) emp &lt;- emp[order(emp$num), ] emp[&quot;dup&quot;] &lt;- duplicated(emp$num) # dim(emp[emp$dup==&#39;TRUE&#39;,]) #62 emp &lt;- emp[emp$dup == &quot;FALSE&quot;, ] emp[, c(&quot;sponge&quot;, &quot;num&quot;, &quot;dup&quot;)] &lt;- list(NULL) OTU_prep_sqrt &lt;- function(micro) { rownames(micro) &lt;- micro$Sample_ID micro$Sample_ID &lt;- NULL # micro &lt;- sqrt(micro) micro_gb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Gb&quot;), ] micro_sf &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Sf&quot;), ] micro_wb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Wb&quot;), ] micro_gb &lt;- micro_gb[, colSums(micro_gb != 0) &gt; 0] #removes columns that only contain 0 micro_sf &lt;- micro_sf[, colSums(micro_sf != 0) &gt; 0] micro_wb &lt;- micro_wb[, colSums(micro_wb != 0) &gt; 0] micros &lt;- list(gb = micro_gb, sf = micro_sf, wb = micro_wb) return(micros) } micro_ds &lt;- OTU_prep_sqrt(micro) overall_rabdc &lt;- function(micro) { mic &lt;- micro n &lt;- 0 k &lt;- dim(mic)[1] mic[&quot;rowsum&quot;] &lt;- apply(mic, 1, sum) while (n &lt; k) { n &lt;- n + 1 mic[n, ] &lt;- mic[n, ]/(mic$rowsum[n]) } mic$rowsum &lt;- NULL mic &lt;- data.frame(t(mic)) mic[&quot;avg_rel_abdc&quot;] &lt;- apply(mic, 1, mean) mic[&quot;occurrence&quot;] &lt;- ifelse(mic$avg &gt; 0.0025, &quot;common&quot;, &quot;rare&quot;) return(mic) } gb_occurrence &lt;- overall_rabdc(micro_ds$gb) sf_occurrence &lt;- overall_rabdc(micro_ds$sf) wb_occurrence &lt;- overall_rabdc(micro_ds$wb) gb_occurrence &lt;- gb_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] gb_occurrence[&quot;XOTU_id&quot;] &lt;- rownames(gb_occurrence) gb_occ_emp &lt;- left_join(gb_occurrence, emp) sf_occurrence &lt;- sf_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] sf_occurrence[&quot;XOTU_id&quot;] &lt;- rownames(sf_occurrence) sf_occ_emp &lt;- left_join(sf_occurrence, emp) wb_occurrence &lt;- wb_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] wb_occurrence[&quot;XOTU_id&quot;] &lt;- rownames(wb_occurrence) wb_occ_emp &lt;- left_join(wb_occurrence, emp) gb_aggr &lt;- aggregate(gb_occ_emp$avg_rel_abdc, by = list(gb_occ_emp$occurrence), FUN = &quot;length&quot;) sf_aggr &lt;- aggregate(sf_occ_emp$avg_rel_abdc, by = list(sf_occ_emp$occurrence), FUN = &quot;length&quot;) wb_aggr &lt;- aggregate(wb_occ_emp$avg_rel_abdc, by = list(wb_occ_emp$occurrence), FUN = &quot;length&quot;) aggr &lt;- cbind(gb_aggr, sf_aggr$x, wb_aggr$x) colnames(aggr) &lt;- c(&quot;OTU classification&quot;, &quot;count Gb&quot;, &quot;count Sf&quot;, &quot;count Wb&quot;) options(kableExtra.html.bsTable = T) kable(aggr, col.names = c(&quot;OTU classification&quot;, &quot;count (Gb)&quot;, &quot;count (Sf)&quot;, &quot;count (Wb)&quot;), booktabs = T, caption = &quot;Number of OTUs being excluded and retained in the three sponges&#39; microbiota when filtering for average relative abundance &gt; 0.25%.&quot;, row.names = FALSE) %&gt;% kable_styling(bootstrap_options = c(&quot;hover&quot;, &quot;bordered&quot;, &quot;condensed&quot;, &quot;responsive&quot;), full_width = F, latex_options = c(&quot;scale_down&quot;)) Table 3.1: Number of OTUs being excluded and retained in the three sponges’ microbiota when filtering for average relative abundance &gt; 0.25%. OTU classification count (Gb) count (Sf) count (Wb) common 96 89 20 rare 324 372 115 That means, for G. barretti we exclude 77.1 % of OTUs, for S. fortis 80.7 % and for W. bursa 85.2%. gb_common &lt;- gb_occ_emp[gb_occ_emp$occurrence == &quot;common&quot;, ] sf_common &lt;- sf_occ_emp[sf_occ_emp$occurrence == &quot;common&quot;, ] wb_common &lt;- wb_occ_emp[wb_occ_emp$occurrence == &quot;common&quot;, ] gb_aggr &lt;- aggregate(gb_common$avg_rel_abdc, by = list(gb_common$spongeEMP_enriched), FUN = &quot;length&quot;) sf_aggr &lt;- aggregate(sf_common$avg_rel_abdc, by = list(sf_common$spongeEMP_enriched), FUN = &quot;length&quot;) wb_aggr &lt;- aggregate(wb_common$avg_rel_abdc, by = list(wb_common$spongeEMP_enriched), FUN = &quot;length&quot;) aggr &lt;- cbind(gb_aggr, sf_aggr$x) aggr &lt;- left_join(aggr, wb_aggr, by = &quot;Group.1&quot;) colnames(aggr) &lt;- c(&quot;EMP OTU count&quot;, &quot;Gb&quot;, &quot;Sf&quot;, &quot;Wb&quot;) options(kableExtra.html.bsTable = T) kable(aggr, col.names = c(&quot;OTU classification&quot;, &quot;count (Gb)&quot;, &quot;count (Sf)&quot;, &quot;count (Wb)&quot;), booktabs = T, caption = &quot;Number of common/abundant OTUs found in the SpongeEMP data base&quot;, row.names = FALSE) %&gt;% kable_styling(bootstrap_options = c(&quot;hover&quot;, &quot;bordered&quot;, &quot;condensed&quot;, &quot;responsive&quot;), full_width = F, latex_options = c(&quot;scale_down&quot;)) Table 3.2: Number of common/abundant OTUs found in the SpongeEMP data base OTU classification count (Gb) count (Sf) count (Wb) no 23 25 9 yes 72 64 11 3.4 Environmental modelling In order to investigate whether and which of the environmental parameter might “explain”/correlate with variation the the microbiota, we apply constrained and unconstrained ecological data analysis methods. 3.4.1 Constrained modelling approach Automatic stepwise model building We use canonical correspondence analysis as method for ordination. According to the manual for the R package vegan, “a good dissimilarity index for multidimensional scaling should have a high rank-order similarity with gradient separation” (Oksanen et al. 2019). Thus interpreting the results of Tab 3.3, we find that square root transformation and Wisconsin standardisation increase the rank correlation between the microbial community dissimilarity matrix and the environmental gradient separation in all three sponge microbiota for a number of ecological dissimilarity indices. library(vegan) microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] # Gb12 has no salinity and temperature: impute from Gb11 &amp; Gb13: Salinity:34.92; # Temp:3.59 row &lt;- which(meta_data$unified_ID == &quot;Gb12&quot;) temp &lt;- which(colnames(meta_data) == &quot;MeanBottomTemp_Cdeg&quot;) sal &lt;- which(colnames(meta_data) == &quot;MeanBotSalinity_PSU&quot;) meta_data[row, temp] &lt;- 3.59 meta_data[row, sal] &lt;- 34.92 rm(row, temp, sal) OTU_prep_sqrt &lt;- function(micro) { rownames(micro) &lt;- micro$Sample_ID micro$Sample_ID &lt;- NULL micro &lt;- sqrt(micro) micro_gb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Gb&quot;), ] micro_sf &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Sf&quot;), ] micro_wb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Wb&quot;), ] micro_gb &lt;- micro_gb[, colSums(micro_gb != 0) &gt; 0] micro_sf &lt;- micro_sf[, colSums(micro_sf != 0) &gt; 0] micro_wb &lt;- micro_wb[, colSums(micro_wb != 0) &gt; 0] micros &lt;- list(gb = micro_gb, sf = micro_sf, wb = micro_wb) return(micros) } microbiomes &lt;- OTU_prep_sqrt(microbiome) md_prep &lt;- function(microbiomes, meta_data) { meta_data &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;YEAR&quot;)] gb &lt;- microbiomes$gb sf &lt;- microbiomes$sf wb &lt;- microbiomes$wb gb_md &lt;- meta_data[meta_data$unified_ID %in% rownames(gb), ] rownames(gb_md) &lt;- gb_md$unified_ID gb_md &lt;- gb_md[order(gb_md$unified_ID), ] all(rownames(microbiomes$gb) == rownames(gb_md)) gb_md &lt;- gb_md[, c(&quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;YEAR&quot;)] sf_md &lt;- meta_data[meta_data$unified_ID %in% rownames(sf), ] rownames(sf_md) &lt;- sf_md$unified_ID sf_md &lt;- sf_md[order(sf_md$unified_ID), ] sf_md$unified_ID &lt;- NULL wb_md &lt;- meta_data[meta_data$unified_ID %in% rownames(wb), ] rownames(wb_md) &lt;- wb_md$unified_ID wb_md &lt;- wb_md[order(wb_md$unified_ID), ] wb_md$unified_ID &lt;- NULL mds &lt;- list(gb_md = gb_md, sf_md = sf_md, wb_md = wb_md) return(mds) } mds &lt;- md_prep(microbiomes, meta_data) # Standardization If there is a large difference between smallest non-zero # abundance and largest abundance, we want to reduce this difference. Usually # square root transformation is sufficient to balance the data. Wisconsin double # standardization often improves the gradient detection ability of dissimilarity # indices. # Which dissimilarity index is best? gb_ri1 &lt;- rankindex(scale(mds$gb_md), (microbiomes$gb)^2, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) #unstandardized gb_ri2 &lt;- rankindex(scale(mds$gb_md), microbiomes$gb, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) #sqrt gb_ri3 &lt;- rankindex(scale(mds$gb_md), wisconsin(microbiomes$gb), c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) #sqrt and wisconsin sf_ri1 &lt;- rankindex(scale(mds$sf_md), (microbiomes$sf)^2, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) sf_ri2 &lt;- rankindex(scale(mds$sf_md), microbiomes$sf, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) sf_ri3 &lt;- rankindex(scale(mds$sf_md), wisconsin(microbiomes$sf), c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) wb_ri1 &lt;- rankindex(scale(mds$wb_md), (microbiomes$wb)^2, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) wb_ri2 &lt;- rankindex(scale(mds$wb_md), microbiomes$wb, c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) wb_ri3 &lt;- rankindex(scale(mds$wb_md), wisconsin(microbiomes$wb), c(&quot;euc&quot;, &quot;man&quot;, &quot;bray&quot;, &quot;jac&quot;, &quot;kul&quot;)) rankindices &lt;- rbind(gb_ri1, gb_ri2, gb_ri3, sf_ri1, sf_ri2, sf_ri3, wb_ri1, wb_ri2, wb_ri3) rankindices &lt;- as.data.frame(rankindices) rankindices[&quot;Sponge species&quot;] &lt;- c(rep(&quot;G. barretti&quot;, 3), rep(&quot;S. fortis&quot;, 3), rep(&quot;W. bursa&quot;, 3)) rankindices[&quot;Normalisation&quot;] &lt;- c(rep(c(&quot;none&quot;, &quot;sqrt&quot;, &quot;sqrt &amp; wisconsin&quot;), 3)) options(kableExtra.html.bsTable = T) kable(rankindices, col.names = c(&quot;Euclidean&quot;, &quot;Manhattan&quot;, &quot;Bray–Curtis&quot;, &quot;Jaccard&quot;, &quot;Kulczynski&quot;, &quot;Sponge species&quot;, &quot;Normalisation&quot;), booktabs = T, caption = &quot;Rank correlation between dissimilarity indices and gradient separation. The higher the number the stronger the correlation, i.e. the better the fit.&quot;, row.names = FALSE) %&gt;% kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;bordered&quot;, &quot;condensed&quot;, &quot;responsive&quot;), full_width = F, latex_options = c(&quot;striped&quot;, &quot;scale_down&quot;)) Table 3.3: Rank correlation between dissimilarity indices and gradient separation. The higher the number the stronger the correlation, i.e. the better the fit. Euclidean Manhattan Bray–Curtis Jaccard Kulczynski Sponge species Normalisation -0.0512024 -0.0445135 0.3979615 0.3979615 0.4509158 G. barretti none 0.0930562 0.1658067 0.3967033 0.3967033 0.4010193 G. barretti sqrt 0.4072305 0.4026915 0.4026915 0.4026915 0.4026915 G. barretti sqrt &amp; wisconsin 0.0816401 0.1826975 0.3111549 0.3111549 0.4108128 S. fortis none 0.3285092 0.3476778 0.4620775 0.4620775 0.4877255 S. fortis sqrt 0.5056811 0.5471905 0.5471905 0.5471905 0.5471905 S. fortis sqrt &amp; wisconsin 0.0280922 0.0994375 0.0008681 0.0008681 0.0048476 W. bursa none 0.0376971 0.4854434 0.2801306 0.2801306 0.2656573 W. bursa sqrt -0.0833252 0.3617890 0.3617890 0.3617890 0.3617890 W. bursa sqrt &amp; wisconsin We adapt the microbial data sets accordingly applying square root transformation and Wisconsin standardisation of the microbiota in all subsequent ecological analyses. Then, we build a model (null model) without any environmental parameters, and one (full model) with the maximum number of environmental parameters (terms) possible so that none of them have a VIF &gt; 10. Finally, we use the stepwise model building function ordistep to determine, which of the environmental parameters is a significant constraint for the microbiomes. The function compares the null model and adds and removes terms from the full model to find (combinations of) significant constraints. The significance of the parameters is then tested in an ANOVA. G. barretti: first the VIFs of all terms included in the full model, second the result of the stepwise model building, third the ANOVA of the suggested model. # mod0 has no terms, intercept only mod1 includes all terms possible with a VIF &lt; # 10. Available: &#39;Depth&#39;, &#39;Latitude&#39;, &#39;Longitude&#39;, &#39;MeanBottomTemp_Cdeg&#39;, # &#39;MeanBotSalinity_PSU&#39;, &#39;YEAR&#39; ## Gb mod0 &lt;- cca(wisconsin(microbiomes$gb) ~ 1, mds$gb_md) mod1 &lt;- cca(wisconsin(microbiomes$gb) ~ Depth + Latitude + MeanBottomTemp_Cdeg + YEAR, mds$gb_md) vif.cca(mod1) ## Depth Latitude MeanBottomTemp_Cdeg YEAR ## 1.230382 1.775034 1.929029 1.651565 mod &lt;- ordistep(mod0, scope = formula(mod1), trace = F) #0 mod$anova ## Df AIC F Pr(&gt;F) ## + Depth 1 6.7097 3.4066 0.005 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 anova(mod) ## Permutation test for cca under reduced model ## Permutation: free ## Number of permutations: 999 ## ## Model: cca(formula = wisconsin(microbiomes$gb) ~ Depth, data = mds$gb_md) ## Df ChiSquare F Pr(&gt;F) ## Model 1 0.34451 3.4066 0.001 *** ## Residual 12 1.21355 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 S. fortis: first the VIFs of all terms included in the full model, second the result of the stepwise model building, third the ANOVA of the suggested model. ## Sf mod0 &lt;- cca(wisconsin(microbiomes$sf) ~ 1, mds$sf_md) mod1 &lt;- cca(wisconsin(microbiomes$sf) ~ Depth + Latitude + YEAR + MeanBotSalinity_PSU + Longitude, mds$sf_md) vif.cca(mod1) ## Depth Latitude YEAR MeanBotSalinity_PSU ## 4.218950 5.079261 1.082453 3.648340 ## Longitude ## 5.071690 mod &lt;- ordistep(mod0, scope = formula(mod1), trace = F) mod$anova ## Df AIC F Pr(&gt;F) ## + Depth 1 13.547 2.1462 0.005 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 anova(mod) ## Permutation test for cca under reduced model ## Permutation: free ## Number of permutations: 999 ## ## Model: cca(formula = wisconsin(microbiomes$sf) ~ Depth, data = mds$sf_md) ## Df ChiSquare F Pr(&gt;F) ## Model 1 0.31199 2.1462 0.001 *** ## Residual 13 1.88978 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 W. bursa: first the VIFs of all terms included in the full model, second the result of the stepwise model building, third the ANOVA of the suggested model. ## Wb mod0 &lt;- cca(wisconsin(microbiomes$wb) ~ 1, mds$wb_md) mod1 &lt;- cca(wisconsin(microbiomes$wb) ~ Depth + Latitude + MeanBottomTemp_Cdeg + YEAR, mds$wb_md) vif.cca(mod1) ## Depth Latitude MeanBottomTemp_Cdeg YEAR ## 2.216302 1.217879 2.402357 1.153565 mod &lt;- ordistep(mod0, scope = formula(mod1), trace = F) mod$anova ## Df AIC F Pr(&gt;F) ## + Depth 1 25.701 1.6576 0.005 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 anova(mod) ## Permutation test for cca under reduced model ## Permutation: free ## Number of permutations: 999 ## ## Model: cca(formula = wisconsin(microbiomes$wb) ~ Depth, data = mds$wb_md) ## Df ChiSquare F Pr(&gt;F) ## Model 1 0.4596 1.6576 0.001 *** ## Residual 14 3.8819 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 For all G. barretti and S. fortis depth is a significant constraint of the microbial community. For W. bursa we find temperature to be a significant constraint. 3.4.2 Unconstrained modelling approach In an alternative approach, we fit environmental vectors onto an ordination of the microbiota. This method allows to include all environmental parameters (regardless of collinearity). Length of the arrow indicates strength of the predictor (environmental parameter). microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- meta_data[meta_data$unified_ID %in% microbiome$Sample_ID, ] row &lt;- which(meta_data$unified_ID == &quot;Gb12&quot;) temp &lt;- which(colnames(meta_data) == &quot;MeanBottomTemp_Cdeg&quot;) sal &lt;- which(colnames(meta_data) == &quot;MeanBotSalinity_PSU&quot;) meta_data[row, temp] &lt;- 3.59 meta_data[row, sal] &lt;- 34.92 rm(row, temp, sal) microbiomes &lt;- OTU_prep_sqrt(microbiome) mds &lt;- md_prep(microbiomes, meta_data) colnames(mds$gb_md) &lt;- c(&quot;Depth&quot;, &quot;Lat&quot;, &quot;Lon&quot;, &quot;Temp&quot;, &quot;Sal&quot;, &quot;Year&quot;) colnames(mds$sf_md) &lt;- c(&quot;Depth&quot;, &quot;Lat&quot;, &quot;Lon&quot;, &quot;Temp&quot;, &quot;Sal&quot;, &quot;Year&quot;) colnames(mds$wb_md) &lt;- c(&quot;Depth&quot;, &quot;Lat&quot;, &quot;Lon&quot;, &quot;Temp&quot;, &quot;Sal&quot;, &quot;Year&quot;) dist_micro &lt;- vegdist(wisconsin(microbiomes$gb)) #distance matrix ordi_micro &lt;- metaMDS(dist_micro, trace = F) # ordination ef &lt;- envfit(ordi_micro, mds$gb_md, permutations = 999) # fitting arrows; STRATA? plot(ordi_micro, display = &quot;sites&quot;) #plot plot(ef, p.max = 0.05) #arrows Figure 3.6: Fitting significant (p&lt;0.05) environmental vectors onto ordination of G. barretti microbiome. dist_micro &lt;- vegdist(wisconsin(microbiomes$sf)) # distance matrix ordi_micro &lt;- metaMDS(dist_micro, trace = F) # ordination ef &lt;- envfit(ordi_micro, mds$sf_md, permutations = 999) # fitting arrows plot(ordi_micro, display = &quot;sites&quot;) # plot plot(ef, p.max = 0.05) # arrows Figure 3.7: Fitting significant (p&lt;0.05) environmental vectors onto ordination of S. fortis microbiome. dist_micro &lt;- vegdist(wisconsin(microbiomes$wb)) # distance matrix ordi_micro &lt;- metaMDS(dist_micro, trace = F) # ordination ef &lt;- envfit(ordi_micro, mds$wb_md, permutations = 999) # fitting arrows plot(ordi_micro, display = &quot;sites&quot;) # plot plot(ef, p.max = 0.05) # arrows Figure 3.8: Fitting significant (p&lt;0.05) environmental vectors onto ordination of W. bursa microbiome. 3.4.3 Hierarchical clustering ## Clustering par(mfrow = c(1, 3)) dist_micro &lt;- vegdist(wisconsin(microbiomes$gb)) #distance matrix clua &lt;- hclust(dist_micro, &quot;average&quot;) #average= UPGMA plot(clua, sub = &quot;Gb&quot;, xlab = &quot;UPGMA&quot;) rect.hclust(clua, 2) grp1 &lt;- cutree(clua, 2) dist_micro &lt;- vegdist(wisconsin(microbiomes$sf)) #distance matrix clua &lt;- hclust(dist_micro, &quot;average&quot;) #average= UPGMA plot(clua, sub = &quot;Sf&quot;, xlab = &quot;UPGMA&quot;) grp2 &lt;- cutree(clua, 2) dist_micro &lt;- vegdist(wisconsin(microbiomes$wb)) #distance matrix clua &lt;- hclust(dist_micro, &quot;average&quot;) #average= UPGMA plot(clua, sub = &quot;Wb&quot;, xlab = &quot;UPGMA&quot;) Figure 3.9: Hclust grp3 &lt;- cutree(clua, 2) par(mfrow = c(1, 1)) # ord &lt;- cca(wisconsin(microbiomes$gb)) plot(ord, display = &#39;sites&#39;) # ordihull(ord, grp1, lty = 2, col = &#39;red&#39;) # ord &lt;- cca(wisconsin(microbiomes$sf)) plot(ord, display = &#39;sites&#39;) # ordihull(ord, grp2, lty = 2, col = &#39;red&#39;) # ord &lt;- cca(wisconsin(microbiomes$wb)) plot(ord, display = &#39;sites&#39;) # ordihull(ord, grp3, lty = 2, col = &#39;red&#39;) To summarise, in this section on environmental modelling, we’ve shown that the prokaryotic communities in G. barretti and S. fortis seem to be influenced by depth both in contrained and unconstrained methods. For W. bursa we get mixed results. Hence at this point, the picture of a depth effect on LMA sponge prokaryotic communities remains ambiguous. Our intention with the hierarchical clustering was to see if we could group the variation in the community composition in order to see if we can take hints from that about which aspect of the (a)biotic environment most likely causes/links to the changes. For G. barretti, we see the two main clusters representing the “shallow” (Gb1-Gb10: 407-801 m) versus the “deep” (Gb11-Gb14: 1213-1427 m) specimens. These two groups match the two water masses detected in this part of the North Atlantic. The clustering also yiels a distinct clade/group of deep specimens in S. fortis (Sf9-Sf15: 1036-1476 m). Again, this highlights the distinctiveness of the prokatyotic commmunity of the deep specimens, potentially linked to the differences in the surrounding water masses. In W. bursa the specimens originating from depths greater than 1000 m (Wb13-Wb16) cluster with shallow samples and thus, we cannot deduce any stratifying effect of depth or water masses on its microbiome. This section has given us a general impression that depth affects (mainly HMA) sponge prokarytoic community compositions. But can we be more specific and identify which OTUs are behind those patterns? 3.5 Relative abundances 3.5.1 Bar plots Enough of the anonymous modelling and data fitting, let’s take a look at the taxonomy of the OTUs to see who is there. micro &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/PANGAEA_Final.csv&quot;, header = T, sep = &quot;;&quot;) taxonomy &lt;- read.csv(&quot;data/microbiome_taxonomy.csv&quot;, header = T, sep = &quot;;&quot;) OTU_prep_sqrt &lt;- function(micro) { rownames(micro) &lt;- micro$Sample_ID micro$Sample_ID &lt;- NULL micro &lt;- sqrt(micro) micro_gb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Gb&quot;), ] micro_sf &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Sf&quot;), ] micro_wb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Wb&quot;), ] micro_gb &lt;- micro_gb[, colSums(micro_gb != 0) &gt; 0] micro_sf &lt;- micro_sf[, colSums(micro_sf != 0) &gt; 0] micro_wb &lt;- micro_wb[, colSums(micro_wb != 0) &gt; 0] micros &lt;- list(gb = micro_gb, sf = micro_sf, wb = micro_wb) return(micros) } micro_ds &lt;- OTU_prep_sqrt(micro) overall_rabdc &lt;- function(micros) { mic &lt;- micros n &lt;- 0 k &lt;- dim(mic)[1] mic[&quot;rowsum&quot;] &lt;- apply(mic, 1, sum) while (n &lt; k) { n &lt;- n + 1 mic[n, ] &lt;- mic[n, ]/(mic$rowsum[n]) } mic$rowsum &lt;- NULL mic &lt;- data.frame(t(mic)) mic[&quot;avg_rel_abdc&quot;] &lt;- apply(mic, 1, mean) mic[&quot;occurrence&quot;] &lt;- ifelse(mic$avg &gt; 0.0025, &quot;common&quot;, &quot;rare&quot;) return(mic) } occurrence &lt;- lapply(micro_ds, overall_rabdc) # PHYLUM adonis_prep &lt;- function(taxonomy, occurrence) { occurrence$gb[&quot;XOTU&quot;] &lt;- rownames(occurrence$gb) occurrence$sf[&quot;XOTU&quot;] &lt;- rownames(occurrence$sf) occurrence$wb[&quot;XOTU&quot;] &lt;- rownames(occurrence$wb) tax &lt;- taxonomy[, c(&quot;OTU_ID&quot;, &quot;Phylum&quot;, &quot;Class&quot;)] n &lt;- 0 k &lt;- dim(tax)[1] tax[&quot;XOTU&quot;] &lt;- NA while (n &lt; k) { n &lt;- n + 1 tax$XOTU[n] &lt;- paste0(&quot;X&quot;, tax$OTU_ID[n]) } tax_gb &lt;- inner_join(tax, occurrence$gb) tax_sf &lt;- inner_join(tax, occurrence$sf) tax_wb &lt;- inner_join(tax, occurrence$wb) taxes &lt;- list(gb = tax_gb, sf = tax_sf, wb = tax_wb) return(taxes) } taxes &lt;- adonis_prep(taxonomy, occurrence) cleaning &lt;- function(taxes) { gb &lt;- taxes$gb sf &lt;- taxes$sf wb &lt;- taxes$wb # Renaming &amp; removing whitespaces gb$Phylum &lt;- as.character(str_trim(as.character(gb$Phylum))) sf$Phylum &lt;- as.character(str_trim(as.character(sf$Phylum))) wb$Phylum &lt;- as.character(str_trim(as.character(wb$Phylum))) gb$Class &lt;- as.character(str_trim(as.character(gb$Class))) sf$Class &lt;- as.character(str_trim(as.character(sf$Class))) wb$Class &lt;- as.character(str_trim(as.character(wb$Class))) ## GB gb$Class[(gb$Phylum == &quot;PAUC34f&quot;)] &lt;- &quot;PAUC34f_unclassified&quot; gb$Class[(gb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; gb$Phylum[(gb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; gb$Class[(gb$Phylum == &quot;Tectomicrobia&quot;)] &lt;- &quot;Tectomicrobia_unclassified&quot; gb$Class[(gb$Phylum == &quot;SBR1093&quot;)] &lt;- &quot;SBR1093_unclassified&quot; gb$Class[(gb$Phylum == &quot;Poribacteria&quot;)] &lt;- &quot;Poribacteria_unclassified&quot; gb$Class[gb$Phylum == &quot;Chloroflexi&quot; &amp; gb$Class == &quot;&quot;] &lt;- &quot;Chloroflexi_unclassified&quot; ## SF sf$Class[(sf$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; sf$Phylum[(sf$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; sf$Class[(sf$Phylum == &quot;PAUC34f&quot;)] &lt;- &quot;PAUC34f_unclassified&quot; sf$Class[(sf$Phylum == &quot;Proteobacteria&quot; &amp; sf$Class == &quot;&quot;)] &lt;- &quot;Proteobacteria_unclassified&quot; sf$Class[(sf$Phylum == &quot;Tectomicrobia&quot;)] &lt;- &quot;Tectomicrobia_unclassified&quot; sf$Class[(sf$Phylum == &quot;SBR1093&quot;)] &lt;- &quot;SBR1093_unclassified&quot; sf$Class[(sf$Phylum == &quot;Poribacteria&quot;)] &lt;- &quot;Poribacteria_unclassified&quot; ## WB wb$Class[(wb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; wb$Phylum[(wb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; # merge back taxes &lt;- list(gb = gb, sf = sf, wb = wb) return(taxes) } taxes &lt;- cleaning(taxes) taxes &lt;- lapply(taxes, function(x) { rownames(x) &lt;- x$XOTU x }) taxes &lt;- lapply(taxes, function(x) { x[c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;, &quot;OTU_ID&quot;, &quot;XOTU&quot;)] &lt;- NULL x }) taxes &lt;- lapply(taxes, function(x) { x[&quot;Class&quot;] &lt;- NULL x }) # aggregate sum of relative abundance per phylum in each sponge sample gb &lt;- aggregate(taxes$gb[, 2:dim(taxes$gb)[2]], list(taxes$gb[, &quot;Phylum&quot;]), sum) #works sf &lt;- aggregate(taxes$sf[, 2:dim(taxes$sf)[2]], list(taxes$sf[, &quot;Phylum&quot;]), sum) #works wb &lt;- aggregate(taxes$wb[, 2:dim(taxes$wb)[2]], list(taxes$wb[, &quot;Phylum&quot;]), sum) #works taxes_phy &lt;- full_join(gb, sf) taxes_phy &lt;- full_join(taxes_phy, wb) taxes_phy[is.na(taxes_phy)] &lt;- 0 # check there are no weird names aggregate(.~ Group.1, data=taxes_phy, sum) rownames(taxes_phy) &lt;- taxes_phy$Group.1 taxes_phy$Group.1 &lt;- NULL df_phylum &lt;- data.frame(t(taxes_phy)) #taxes_phy_t &lt;- df_phylum df_phylum[&quot;Sample_ID&quot;] &lt;- rownames(df_phylum) df_phylum &lt;- melt(df_phylum, id.vars = c(&quot;Sample_ID&quot;)) colnames(df_phylum) &lt;- c(&quot;Sample_ID&quot;, &quot;Phylum&quot;, &quot;variable&quot;) # ggplot(df_phylum, aes(x=Sample_ID, y=variable, # fill=Phylum))+geom_bar(stat=&#39;identity&#39;)+ theme_classic()+theme(axis.text.x = # element_text(angle = 90, hjust = 1), legend.position = &#39;bottom&#39;)+xlab(&#39;Samples # ordered by depth&#39;)+ylab(&#39;Relative abundance&#39;)+ # scale_x_discrete(limits=c(&#39;Gb1&#39;,&#39;Gb2&#39;,&#39;Gb3&#39;, &#39;Gb4&#39;, &#39;Gb5&#39;, &#39;Gb6&#39;, &#39;Gb7&#39;, &#39;Gb8&#39;, # &#39;Gb9&#39;, &#39;Gb10&#39;, &#39;Gb11&#39;, &#39;Gb12&#39;, &#39;Gb13&#39;, &#39;Gb14&#39;, &#39;Sf1&#39;, &#39;Sf2&#39;, &#39;Sf3&#39;, &#39;Sf4&#39;, # &#39;Sf5&#39;, &#39;Sf6&#39;, &#39;Sf7&#39;, &#39;Sf8&#39;, &#39;Sf9&#39;, &#39;Sf10&#39;, &#39;Sf11&#39;, &#39;Sf12&#39;, &#39;Sf13&#39;, &#39;Sf14&#39;, # &#39;Sf15&#39;, &#39;Wb1&#39;, &#39;Wb2&#39;, &#39;Wb3&#39;, &#39;Wb4&#39;, &#39;Wb5&#39;, &#39;Wb6&#39;, &#39;Wb7&#39;, &#39;Wb8&#39;, &#39;Wb9&#39;, &#39;Wb10&#39;, # &#39;Wb11&#39;, &#39;Wb12&#39;, &#39;Wb13&#39;, &#39;Wb14&#39;, &#39;Wb15&#39;, &#39;Wb16&#39;))+ scale_fill_manual(&#39;&#39;, breaks # = c(&#39;Acidobacteria&#39;, &#39;Actinobacteria&#39;, &#39;Bacteroidetes&#39;, &#39;Chlamydiae&#39;, # &#39;Chloroflexi&#39;, &#39;Cyanobacteria&#39;, &#39;Deferribacteres&#39;, &#39;Deinococcus.Thermus&#39;, # &#39;Firmicutes&#39;, &#39;Gemmatimonadetes&#39;, &#39;Nitrospinae&#39;, &#39;Nitrospirae&#39;, &#39;PAUC34f&#39;, # &#39;Planctomycetes&#39;, &#39;Poribacteria&#39;, &#39;Proteobacteria&#39;, &#39;SBR1093&#39;, &#39;Spirochaetae&#39;, # &#39;Tectomicrobia&#39;, &#39;Thaumarchaeota&#39;, &#39;unclassified&#39;, &#39;Verrucomicrobia&#39;), values = # c(&#39;#b8c4f6&#39;,&#39;#ffaaaf&#39;,&#39;#3d1349&#39;,&#39;#ffffff&#39;,&#39;#01559d&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#019c51&#39;,&#39;#b10060&#39;,&#39;#49ca00&#39;,&#39;#dd8e00&#39;,&#39;#f282ff&#39;,&#39;#ffffff&#39;,&#39;#ff633f&#39;,&#39;#ec0040&#39;,&#39;#010b92&#39;,&#39;#cf00aa&#39;,&#39;#aba900&#39;,&#39;#ffffff&#39;,&#39;#fce300&#39;), # labels = c(&#39;Acidobacteria&#39;, &#39;Actinobacteria&#39;, &#39;Bacteroidetes&#39;, &#39;Chlamydiae&#39;, # &#39;Chloroflexi&#39;, &#39;Cyanobacteria&#39;, &#39;Deferribacteres&#39;, &#39;Deinococcus.Thermus&#39;, # &#39;Firmicutes&#39;, &#39;Gemmatimonadetes&#39;, &#39;Nitrospinae&#39;, &#39;Nitrospirae&#39;, &#39;PAUC34f&#39;, # &#39;Planctomycetes&#39;, &#39;Poribacteria&#39;, &#39;Proteobacteria&#39;, &#39;SBR1093&#39;, &#39;Spirochaetae&#39;, # &#39;Tectomicrobia&#39;, &#39;Thaumarchaeota&#39;, &#39;unclassified&#39;, &#39;Verrucomicrobia&#39;)) # df_phylum[&#39;spec&#39;] &lt;- str_sub(df_phylum$Sample_ID,1,2) md &lt;- # meta_data[,c(&#39;unified_ID&#39;, &#39;Depth&#39;)] colnames(md) &lt;- c(&#39;Sample_ID&#39;, &#39;Depth&#39;) # df_phylum &lt;- left_join(df_phylum, md) # ggplot(df_phylum, aes(x=as.factor(Depth), y=variable, fill=Phylum))+ # geom_bar(stat=&#39;identity&#39;)+facet_wrap(.~spec, scales=&#39;free&#39;)+ # theme_classic()+theme(axis.text.x = element_text(angle = 90, hjust = # 1),legend.position = &#39;bottom&#39;)+xlab(&#39;Samples ordered by depth&#39;)+ylab(&#39;Relative # abundance&#39;)+ scale_fill_manual(&#39;&#39;, breaks = c(&#39;Acidobacteria&#39;, # &#39;Actinobacteria&#39;, &#39;Bacteroidetes&#39;, &#39;Chlamydiae&#39;, &#39;Chloroflexi&#39;, # &#39;Cyanobacteria&#39;, &#39;Deferribacteres&#39;, &#39;Deinococcus.Thermus&#39;, &#39;Firmicutes&#39;, # &#39;Gemmatimonadetes&#39;, &#39;Nitrospinae&#39;, &#39;Nitrospirae&#39;, &#39;PAUC34f&#39;, &#39;Planctomycetes&#39;, # &#39;Poribacteria&#39;, &#39;Proteobacteria&#39;, &#39;SBR1093&#39;, &#39;Spirochaetae&#39;, &#39;Tectomicrobia&#39;, # &#39;Thaumarchaeota&#39;, &#39;unclassified&#39;, &#39;Verrucomicrobia&#39;), values = # c(&#39;#b8c4f6&#39;,&#39;#ffaaaf&#39;,&#39;#3d1349&#39;,&#39;#ffffff&#39;,&#39;#01559d&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#ffffff&#39;,&#39;#019c51&#39;,&#39;#b10060&#39;,&#39;#49ca00&#39;,&#39;#dd8e00&#39;,&#39;#f282ff&#39;,&#39;#ffffff&#39;,&#39;#ff633f&#39;,&#39;#ec0040&#39;,&#39;#010b92&#39;,&#39;#cf00aa&#39;,&#39;#aba900&#39;,&#39;#ffffff&#39;,&#39;#fce300&#39;), # labels = c(&#39;Acidobacteria&#39;, &#39;Actinobacteria&#39;, &#39;Bacteroidetes&#39;, &#39;Chlamydiae&#39;, # &#39;Chloroflexi&#39;, &#39;Cyanobacteria&#39;, &#39;Deferribacteres&#39;, &#39;Deinococcus.Thermus&#39;, # &#39;Firmicutes&#39;, &#39;Gemmatimonadetes&#39;, &#39;Nitrospinae&#39;, &#39;Nitrospirae&#39;, &#39;PAUC34f&#39;, # &#39;Planctomycetes&#39;, &#39;Poribacteria&#39;, &#39;Proteobacteria&#39;, &#39;SBR1093&#39;, &#39;Spirochaetae&#39;, # &#39;Tectomicrobia&#39;, &#39;Thaumarchaeota&#39;, &#39;unclassified&#39;, &#39;Verrucomicrobia&#39;) ) last_plot() + scale_fill_manual(&quot;&quot;, breaks = c(&quot;Acidobacteria&quot;, &quot;Actinobacteria&quot;, &quot;Bacteroidetes&quot;, &quot;Chlamydiae&quot;, &quot;Chloroflexi&quot;, &quot;Cyanobacteria&quot;, &quot;Deferribacteres&quot;, &quot;Deinococcus.Thermus&quot;, &quot;Firmicutes&quot;, &quot;Gemmatimonadetes&quot;, &quot;Nitrospinae&quot;, &quot;Nitrospirae&quot;, &quot;PAUC34f&quot;, &quot;Planctomycetes&quot;, &quot;Poribacteria&quot;, &quot;Proteobacteria&quot;, &quot;SBR1093&quot;, &quot;Spirochaetae&quot;, &quot;Tectomicrobia&quot;, &quot;Thaumarchaeota&quot;, &quot;unclassified&quot;, &quot;Verrucomicrobia&quot;), values = c(&quot;#b8c4f6&quot;, &quot;#ffaaaf&quot;, &quot;#3d1349&quot;, &quot;#B6B2A9&quot;, &quot;#01559d&quot;, &quot;#CACAC8&quot;, &quot;#E1DED7&quot;, &quot;#CEC7C1&quot;, &quot;#9A9B9D&quot;, &quot;#019c51&quot;, &quot;#b10060&quot;, &quot;#49ca00&quot;, &quot;#dd8e00&quot;, &quot;#f282ff&quot;, &quot;#AFA79D&quot;, &quot;#ff633f&quot;, &quot;#ec0040&quot;, &quot;#010b92&quot;, &quot;#cf00aa&quot;, &quot;#aba900&quot;, &quot;#ffffff&quot;, &quot;#fce300&quot;), labels = c(&quot;Acidobacteria&quot;, &quot;Actinobacteria&quot;, &quot;Bacteroidetes&quot;, &quot;Chlamydiae&quot;, &quot;Chloroflexi&quot;, &quot;Cyanobacteria&quot;, &quot;Deferribacteres&quot;, &quot;Deinococcus.Thermus&quot;, &quot;Firmicutes&quot;, &quot;Gemmatimonadetes&quot;, &quot;Nitrospinae&quot;, &quot;Nitrospirae&quot;, &quot;PAUC34f&quot;, &quot;Planctomycetes&quot;, &quot;Poribacteria&quot;, &quot;Proteobacteria&quot;, &quot;SBR1093&quot;, &quot;Spirochaetae&quot;, &quot;Tectomicrobia&quot;, &quot;Thaumarchaeota&quot;, &quot;unclassified&quot;, &quot;Verrucomicrobia&quot;)) ## NULL We see in this bar plot that the relative abundance of phyla remains fairly stable across the different depths. Generally, the prokaryotic community of sponges is described as somewhat species specific and stable across virtually any measured gradient. At this taxonomic resolution, these findings hold true. The composition of the prokaryotic communities in the HMA sponges G. barretti and S. fortis is similar across all samples, while the composition in the LMA sponge W. bursa differs in composition but also displaying only minor variations in phyla proportions. The phyla left white/blank are present at very low abundance and we thought the figure might be visually easier without too many colours. The phyla Chloroflexi, Actinobacteria, Acidobacteria, PAUC34f, and Gemmatimonadetes were described as HMA indicator phyla (Moitinho-Silva et al. 2017) and are present in the HMA sponges G. barretti and S. fortis (although Actinobacteria are also present in W. bursa).The phyla Proteobacteria, Bacteroidetes, Planctomycetes, and Firmicutes were disgnated LMA indicator phyla and are found in W. bursa (although Proteobacteria are also present in the HMA sponges). 3.5.2 Tabular overview If you prefer numbers, this is what it breaks down to. You can sort the tables. microbiome &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) OTU_prep_sqrt &lt;- function(micro) { rownames(micro) &lt;- micro$Sample_ID micro$Sample_ID &lt;- NULL micro &lt;- sqrt(micro) micro_gb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Gb&quot;), ] micro_sf &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Sf&quot;), ] micro_wb &lt;- micro[(str_sub(rownames(micro), 1, 2) == &quot;Wb&quot;), ] micro_gb &lt;- micro_gb[, colSums(micro_gb != 0) &gt; 0] micro_sf &lt;- micro_sf[, colSums(micro_sf != 0) &gt; 0] micro_wb &lt;- micro_wb[, colSums(micro_wb != 0) &gt; 0] micros &lt;- list(gb = micro_gb, sf = micro_sf, wb = micro_wb) return(micros) } micro_ds &lt;- OTU_prep_sqrt(microbiome) # calculate relative abundance of OTU across sponge samples overall_rabdc &lt;- function(micros) { mic &lt;- micros n &lt;- 0 k &lt;- dim(mic)[1] mic[&quot;rowsum&quot;] &lt;- apply(mic, 1, sum) while (n &lt; k) { n &lt;- n + 1 mic[n, ] &lt;- mic[n, ]/(mic$rowsum[n]) } mic$rowsum &lt;- NULL mic &lt;- data.frame(t(mic)) mic[&quot;avg_rel_abdc&quot;] &lt;- apply(mic, 1, mean) mic[&quot;occurrence&quot;] &lt;- ifelse(mic$avg &gt; 0.0025, &quot;common&quot;, &quot;rare&quot;) return(mic) } # gb_occurrence &lt;- overall_rabdc(micro_ds$gb) sf_occurrence &lt;- # overall_rabdc(micro_ds$sf) wb_occurrence &lt;- overall_rabdc(micro_ds$wb) # occurrence &lt;- list(gb=gb_occurrence, sf=sf_occurrence, wb=wb_occurrence) occurrence &lt;- lapply(micro_ds, overall_rabdc) aggregations &lt;- function(taxonomy, occurrence) { occurrence$gb[&quot;XOTU&quot;] &lt;- rownames(occurrence$gb) occurrence$sf[&quot;XOTU&quot;] &lt;- rownames(occurrence$sf) occurrence$wb[&quot;XOTU&quot;] &lt;- rownames(occurrence$wb) tax &lt;- taxonomy[, c(&quot;OTU_ID&quot;, &quot;Phylum&quot;, &quot;Class&quot;)] n &lt;- 0 k &lt;- dim(tax)[1] tax[&quot;XOTU&quot;] &lt;- NA while (n &lt; k) { n &lt;- n + 1 tax$XOTU[n] &lt;- paste0(&quot;X&quot;, tax$OTU_ID[n]) } tax_gb &lt;- inner_join(tax, occurrence$gb[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) tax_sf &lt;- inner_join(tax, occurrence$sf[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) tax_wb &lt;- inner_join(tax, occurrence$wb[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) taxes &lt;- list(gb = tax_gb, sf = tax_sf, wb = tax_wb) gb1 &lt;- aggregate(tax_gb$Phylum, by = list(tax_gb$Phylum), FUN = &quot;length&quot;) gb2 &lt;- aggregate(tax_gb$avg_rel_abdc, by = list(tax_gb$Phylum), FUN = &quot;sum&quot;) gb_p &lt;- full_join(gb1, gb2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(gb_p) &lt;- c(&quot;Phylum&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) gb1 &lt;- aggregate(tax_gb$Class, by = list(tax_gb$Class), FUN = &quot;length&quot;) gb2 &lt;- aggregate(tax_gb$avg_rel_abdc, by = list(tax_gb$Class), FUN = &quot;sum&quot;) gb_c &lt;- full_join(gb1, gb2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(gb_c) &lt;- c(&quot;Class&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) test1 &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;length&quot;)) lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;sum&quot;)) return(taxes) } taxes &lt;- aggregations(taxonomy, occurrence) cleaning &lt;- function(taxes) { gb &lt;- taxes$gb sf &lt;- taxes$sf wb &lt;- taxes$wb # Renaming &amp; removing whitespaces gb$Phylum &lt;- as.character(str_trim(as.character(gb$Phylum))) sf$Phylum &lt;- as.character(str_trim(as.character(sf$Phylum))) wb$Phylum &lt;- as.character(str_trim(as.character(wb$Phylum))) gb$Class &lt;- as.character(str_trim(as.character(gb$Class))) sf$Class &lt;- as.character(str_trim(as.character(sf$Class))) wb$Class &lt;- as.character(str_trim(as.character(wb$Class))) ## GB gb$Class[(gb$Phylum == &quot;PAUC34f&quot;)] &lt;- &quot;PAUC34f_unclassified&quot; gb$Class[(gb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; gb$Phylum[(gb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; gb$Class[(gb$Phylum == &quot;Tectomicrobia&quot;)] &lt;- &quot;Tectomicrobia_unclassified&quot; gb$Class[(gb$Phylum == &quot;SBR1093&quot;)] &lt;- &quot;SBR1093_unclassified&quot; gb$Class[(gb$Phylum == &quot;Poribacteria&quot;)] &lt;- &quot;Poribacteria_unclassified&quot; gb$Class[gb$Phylum == &quot;Chloroflexi&quot; &amp; gb$Class == &quot;&quot;] &lt;- &quot;Chloroflexi_unclassified&quot; ## SF sf$Class[(sf$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; sf$Phylum[(sf$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; sf$Class[(sf$Phylum == &quot;PAUC34f&quot;)] &lt;- &quot;PAUC34f_unclassified&quot; sf$Class[(sf$Phylum == &quot;Proteobacteria&quot; &amp; sf$Class == &quot;&quot;)] &lt;- &quot;Proteobacteria_unclassified&quot; sf$Class[(sf$Phylum == &quot;Tectomicrobia&quot;)] &lt;- &quot;Tectomicrobia_unclassified&quot; sf$Class[(sf$Phylum == &quot;SBR1093&quot;)] &lt;- &quot;SBR1093_unclassified&quot; sf$Class[(sf$Phylum == &quot;Poribacteria&quot;)] &lt;- &quot;Poribacteria_unclassified&quot; ## WB wb$Class[(wb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; wb$Phylum[(wb$Phylum == &quot;&quot;)] &lt;- &quot;unclassified&quot; # merge back taxes &lt;- list(gb = gb, sf = sf, wb = wb) return(taxes) } taxes &lt;- cleaning(taxes) phy_OTU &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;length&quot;)) #OTU count phy_rabdc &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;sum&quot;)) #sums relative abundance class_OTU &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Class, data = x, FUN = &quot;length&quot;)) class_rabdc &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Class, data = x, FUN = &quot;sum&quot;)) 3.5.2.1 G. barretti: Phyla and classes present # https://rstudio.github.io/DT/ gb_P &lt;- cbind(phy_OTU$gb, phy_rabdc$gb[, (&quot;avg_rel_abdc&quot;)]) colnames(gb_P) &lt;- c(&quot;Phylum&quot;, &quot;OTU count&quot;, &quot;cum. avg. abundance&quot;) # gb_P$`cummulative average abundance` &lt;- round(c(gb_P$`cummulative average # abundance`, 6)) DT::datatable(gb_P, rownames = FALSE) gb_C &lt;- cbind(class_OTU$gb, class_rabdc$gb[, (&quot;avg_rel_abdc&quot;)]) colnames(gb_C) &lt;- c(&quot;Class&quot;, &quot;OTU count&quot;, &quot;cummulative average abundance&quot;) # gb_C$`cummulative average abundance` &lt;- round(c(gb_C$`cummulative average # abundance`, digits = 6)) DT::datatable(gb_C, rownames = FALSE) 3.5.2.2 S. fortis: Phyla and classes present sf_P &lt;- cbind(phy_OTU$sf, phy_rabdc$sf[, (&quot;avg_rel_abdc&quot;)]) colnames(sf_P) &lt;- c(&quot;Phylum&quot;, &quot;OTU count&quot;, &quot;cum. avg. abundance&quot;) # sf_P$`cummulative average abundance` &lt;- round(c(sf_P$`cummulative average # abundance`, digits = 6)) DT::datatable(sf_P, rownames = FALSE) sf_C &lt;- cbind(class_OTU$sf, class_rabdc$sf[, (&quot;avg_rel_abdc&quot;)]) colnames(sf_C) &lt;- c(&quot;Class&quot;, &quot;OTU count&quot;, &quot;cummulative average abundance&quot;) # sf_C$`cummulative average abundance` &lt;- round(c(sf_C$`cummulative average # abundance`, digits = 6)) DT::datatable(sf_C, rownames = FALSE) 3.5.2.3 W. bursa: Phyla and classes present wb_P &lt;- cbind(phy_OTU$wb, phy_rabdc$wb[, (&quot;avg_rel_abdc&quot;)]) colnames(wb_P) &lt;- c(&quot;Phylum&quot;, &quot;OTU count&quot;, &quot;cummulative average abundance&quot;) # wb_P$`cummulative average abundance` &lt;- round(c(wb_P$`cummulative average # abundance`, digits = 6)) DT::datatable(wb_P, rownames = FALSE) wb_C &lt;- cbind(class_OTU$wb, class_rabdc$wb[, (&quot;avg_rel_abdc&quot;)]) colnames(wb_C) &lt;- c(&quot;Class&quot;, &quot;OTU count&quot;, &quot;cummulative average abundance&quot;) # wb_C$`cummulative average abundance` &lt;- round(c(wb_C$`cummulative average # abundance`, digits = 6)) DT::datatable(wb_C, rownames = FALSE) rm(gb_P, sf_P, wb_P, gb_C, sf_C, wb_C) 3.5.3 Statistical comparison at phylum and class level 3.6 Depth response: OTU perspective Summarising the OTU diversity by phylum or class only shows what was previously known. The composition of the sponges’ prokaryotic community is stable. However, summarising doesn’t do the data justice. We therefore correlate the average relative abundance of every OTU with depth. The Otus yielding a significant correlation with depth are shown by their respecive relative abundance across the depths. # ====================== INC-DEC CORRELATION ================== Categorises the # OTUs by their response to depth. micro &lt;- read.csv(&quot;data/OTU_all_R.csv&quot;, header = T, sep = &quot;;&quot;) meta_data &lt;- read.csv(&quot;data/Steffen_et_al_metadata_PANGAEA.csv&quot;, header = T, sep = &quot;;&quot;) meta_data_prep &lt;- function(meta_data) { meta_data &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;MeanBottomTemp_Cdeg&quot;, &quot;MeanBotSalinity_PSU&quot;, &quot;YEAR&quot;)] colnames(meta_data) &lt;- c(&quot;unified_ID&quot;, &quot;Depth&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;Temperature&quot;, &quot;Salinity&quot;, &quot;Year&quot;) meta_data &lt;- meta_data[!(str_sub(meta_data$unified_ID, 1, 2) == &quot;QC&quot;), ] meta_data[] &lt;- lapply(meta_data, function(x) if (is.factor(x)) factor(x) else x) # Gb12, Gb20 and Gb21 are missing temperature and salinity. Imputing data from # closeby samples: meta_data$Salinity[meta_data$unified_ID == &quot;Gb12&quot;] &lt;- 34.92 meta_data$Salinity[meta_data$unified_ID == &quot;Gb20&quot;] &lt;- 34.92 meta_data$Salinity[meta_data$unified_ID == &quot;Gb21&quot;] &lt;- 34.56 meta_data$Temperature[meta_data$unified_ID == &quot;Gb12&quot;] &lt;- 3.71 meta_data$Temperature[meta_data$unified_ID == &quot;Gb20&quot;] &lt;- 3.65 meta_data$Temperature[meta_data$unified_ID == &quot;Gb21&quot;] &lt;- 2.32 meta_data[&quot;spec&quot;] &lt;- str_sub(meta_data$unified_ID, 1, 2) meta_data &lt;- meta_data[order(meta_data$unified_ID), ] return(meta_data) } meta_data &lt;- meta_data_prep(meta_data) micro_ds &lt;- OTU_prep_sqrt(micro) rel_abdc &lt;- function(micro) { mic &lt;- micro mic &lt;- data.frame(t(mic)) mic[&quot;max&quot;] &lt;- apply(mic, 1, max) n &lt;- 0 k &lt;- dim(mic)[1] while (n &lt; k) { n &lt;- n + 1 mic[n, ] &lt;- mic[n, ]/(mic$max[n]) } mic$max &lt;- NULL return(mic) } rabdc_gb &lt;- rel_abdc(micro_ds$gb) rabdc_sf &lt;- rel_abdc(micro_ds$sf) rabdc_wb &lt;- rel_abdc(micro_ds$wb) inc_dec &lt;- function(rabdc_df, meta_data) { md &lt;- meta_data[meta_data$unified_ID %in% colnames(rabdc_df), ] inc_dec &lt;- data.frame(rownames(rabdc_df)) colnames(inc_dec) &lt;- &quot;XOTU&quot; inc_dec[&quot;inc_dec_estimate&quot;] &lt;- NA inc_dec[&quot;inc_dec_p_val&quot;] &lt;- NA n &lt;- 0 k &lt;- dim(inc_dec)[1] while (n &lt; k) { n &lt;- n + 1 inc_dec$inc_dec_estimate[n] &lt;- cor.test(as.numeric(rabdc_df[n, ]), md$Depth)$estimate inc_dec$inc_dec_p_val[n] &lt;- cor.test(as.numeric(rabdc_df[n, ]), md$Depth)$p.value } inc_dec[&quot;classification&quot;] &lt;- NA inc_dec$classification[inc_dec$inc_dec_estimate &lt; 0] &lt;- &quot;dec.trend&quot; inc_dec$classification[inc_dec$inc_dec_estimate &gt; 0] &lt;- &quot;inc.trend&quot; inc_dec$classification[inc_dec$inc_dec_estimate &lt; 0 &amp; inc_dec$inc_dec_p &lt;= 0.05] &lt;- &quot;decreasing&quot; inc_dec$classification[inc_dec$inc_dec_estimate &gt; 0 &amp; inc_dec$inc_dec_p &lt;= 0.05] &lt;- &quot;increasing&quot; return(inc_dec) } gb_response &lt;- inc_dec(rabdc_gb, meta_data) sf_response &lt;- inc_dec(rabdc_sf, meta_data) wb_response &lt;- inc_dec(rabdc_wb, meta_data) ### dfs to saving, join _reponse to rabdc_ and calculate vag &lt;/&gt;1000 m # For heatmaps gb rabdc_gb[&quot;XOTU&quot;] &lt;- rownames(rabdc_gb) gb_heatmap &lt;- full_join(rabdc_gb, gb_response) gb_heatmap &lt;- melt(gb_heatmap, id.vars = c(&quot;XOTU&quot;, &quot;inc_dec_estimate&quot;, &quot;inc_dec_p_val&quot;, &quot;classification&quot;)) md &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;)] colnames(md) &lt;- c(&quot;variable&quot;, &quot;Depth&quot;) gb_heatmap &lt;- left_join(gb_heatmap, md) gb_heatmap[&quot;name&quot;] &lt;- str_sub(gb_heatmap$XOTU, -3) gb_heatmap_i &lt;- gb_heatmap[gb_heatmap$classification == &quot;increasing&quot;, ] gb_heatmap_d &lt;- gb_heatmap[gb_heatmap$classification == &quot;decreasing&quot;, ] # gb_i &lt;- ggplot(gb_heatmap_i, aes(x=as.factor(gb_heatmap_i$Depth), # y=gb_heatmap_i$name, fill=gb_heatmap_i$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;GB # OTUs increasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # gb_d &lt;- ggplot(gb_heatmap_d, aes(x=as.factor(gb_heatmap_d$Depth), # y=gb_heatmap_d$name, fill=gb_heatmap_d$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;GB # OTUs decreasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # sf rabdc_sf[&quot;XOTU&quot;] &lt;- rownames(rabdc_sf) sf_heatmap &lt;- full_join(rabdc_sf, sf_response) sf_heatmap &lt;- melt(sf_heatmap, id.vars = c(&quot;XOTU&quot;, &quot;inc_dec_estimate&quot;, &quot;inc_dec_p_val&quot;, &quot;classification&quot;)) md &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;)] colnames(md) &lt;- c(&quot;variable&quot;, &quot;Depth&quot;) sf_heatmap &lt;- left_join(sf_heatmap, md) sf_heatmap[&quot;name&quot;] &lt;- str_sub(sf_heatmap$XOTU, -3) sf_heatmap_i &lt;- sf_heatmap[sf_heatmap$classification == &quot;increasing&quot;, ] sf_heatmap_d &lt;- sf_heatmap[sf_heatmap$classification == &quot;decreasing&quot;, ] # sf_i &lt;- ggplot(sf_heatmap_i, aes(x=as.factor(sf_heatmap_i$Depth), # y=sf_heatmap_i$name, fill=sf_heatmap_i$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;SF # OTUs increasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # sf_d &lt;- ggplot(sf_heatmap_d, aes(x=as.factor(sf_heatmap_d$Depth), # y=sf_heatmap_d$name, fill=sf_heatmap_d$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;SF # OTUs decreasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # wb rabdc_wb[&quot;XOTU&quot;] &lt;- rownames(rabdc_wb) wb_heatmap &lt;- full_join(rabdc_wb, wb_response) wb_heatmap &lt;- melt(wb_heatmap, id.vars = c(&quot;XOTU&quot;, &quot;inc_dec_estimate&quot;, &quot;inc_dec_p_val&quot;, &quot;classification&quot;)) md &lt;- meta_data[, c(&quot;unified_ID&quot;, &quot;Depth&quot;)] colnames(md) &lt;- c(&quot;variable&quot;, &quot;Depth&quot;) wb_heatmap &lt;- left_join(wb_heatmap, md) wb_heatmap[&quot;name&quot;] &lt;- str_sub(wb_heatmap$XOTU, -3) wb_heatmap_i &lt;- wb_heatmap[wb_heatmap$classification == &quot;increasing&quot;, ] wb_heatmap_d &lt;- wb_heatmap[wb_heatmap$classification == &quot;decreasing&quot;, ] # wb_i &lt;- ggplot(wb_heatmap_i, aes(x=as.factor(wb_heatmap_i$Depth), # y=wb_heatmap_i$name, fill=wb_heatmap_i$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;WB # OTUs increasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # wb_d &lt;- ggplot(wb_heatmap_d, aes(x=as.factor(wb_heatmap_d$Depth), # y=wb_heatmap_d$name, fill=wb_heatmap_d$value))+geom_tile()+ theme(axis.text.x = # element_text(angle = 90, hjust = 1))+xlab(&#39;Depth&#39;)+ylab(&#39;OTUs&#39;)+ggtitle(&#39;WB # OTUs decreasing&#39;)+scale_fill_viridis_c(option = # &#39;plasma&#39;)+coord_equal()+theme(plot.background=element_blank(), # panel.border=element_blank(), # legend.title=element_blank(),legend.position=&#39;bottom&#39;) # Facetting for the figure in the publication gb_heatmap_i[&quot;spec&quot;] &lt;- c(&quot;Geodia barretti&quot;) sf_heatmap_i[&quot;spec&quot;] &lt;- c(&quot;Stryphnus fortis&quot;) wb_heatmap_i[&quot;spec&quot;] &lt;- c(&quot;Weberella bursa&quot;) increase &lt;- rbind(gb_heatmap_i, sf_heatmap_i, wb_heatmap_i) inc &lt;- ggplot(increase, aes(x = as.factor(Depth), y = name, fill = value)) + facet_grid(. ~ spec, space = &quot;free&quot;, scales = &quot;free&quot;) + geom_tile() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(&quot;Depth&quot;) + ylab(&quot;OTUs&quot;) + ggtitle(&quot;OTUs increasing&quot;) + scale_fill_viridis_c(option = &quot;plasma&quot;) + theme(plot.background = element_blank(), panel.border = element_blank(), legend.title = element_blank(), legend.position = &quot;bottom&quot;) gb_heatmap_d[&quot;spec&quot;] &lt;- c(&quot;Geodia barretti&quot;) sf_heatmap_d[&quot;spec&quot;] &lt;- c(&quot;Stryphnus fortis&quot;) wb_heatmap_d[&quot;spec&quot;] &lt;- c(&quot;Weberella bursa&quot;) decrease &lt;- rbind(gb_heatmap_d, sf_heatmap_d, wb_heatmap_d) dec &lt;- ggplot(decrease, aes(x = as.factor(Depth), y = name, fill = value)) + facet_grid(. ~ spec, space = &quot;free&quot;, scales = &quot;free&quot;, drop = T) + geom_tile() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(&quot;Depth&quot;) + ylab(&quot;OTUs&quot;) + ggtitle(&quot;OTUs decreasing&quot;) + scale_fill_viridis_c(option = &quot;plasma&quot;) + theme(plot.background = element_blank(), panel.border = element_blank(), legend.title = element_blank(), legend.position = &quot;bottom&quot;) library(gridExtra) grid.arrange(inc, dec, nrow = 1) Figure 3.10: OTUs significantly increasing and decreasing with depth in the three sponge species. gb_nums &lt;- c(length(unique(gb_heatmap$name)), length(unique(gb_heatmap_i$name)), length(unique(gb_heatmap_d$name))) sf_nums &lt;- c(length(unique(sf_heatmap$name)), length(unique(sf_heatmap_i$name)), length(unique(sf_heatmap_d$name))) wb_nums &lt;- c(length(unique(wb_heatmap$name)), length(unique(wb_heatmap_i$name)), length(unique(wb_heatmap_d$name))) overview &lt;- rbind(gb_nums, sf_nums, wb_nums) colnames(overview) &lt;- c(&quot;Total&quot;, &quot;increasing&quot;, &quot;decreasing&quot;) rownames(overview) &lt;- c(&quot;G. barretti microbiota&quot;, &quot;S. fortis microbiota&quot;, &quot;W. bursa microbiota&quot;) overview &lt;- data.frame(overview) overview[&quot;unaffected&quot;] &lt;- overview$Total - (overview$increasing + overview$decreasing) kable(overview, col.names = c(&quot;Total&quot;, &quot;N OTUs increasing&quot;, &quot;N OTUs decreasing&quot;, &quot;N OTUs unaffected&quot;), escape = F, align = &quot;c&quot;, booktabs = T, caption = &quot;Microbiota response to depth&quot;, &quot;html&quot;) %&gt;% kable_styling(bootstrap_options = c(&quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;, latex_options = &quot;striped&quot;, full_width = F)) Table 3.4: Microbiota response to depth Total N OTUs increasing N OTUs decreasing N OTUs unaffected G. barretti microbiota 420 82 58 280 S. fortis microbiota 461 72 32 357 W. bursa microbiota 135 11 13 111 # overview &lt;- overview[,c(2:4)] overview[&#39;response&#39;] &lt;- rownames(overview) plot # &lt;- melt(overview) # stacked &lt;- ggplot(plot, aes(x=response, y=value, fill=variable)) + # geom_bar(position=&#39;stack&#39;, stat=&#39;identity&#39;)+ theme_minimal()+ggtitle(&#39;Stacked # counts&#39;)+xlab(&#39;Sponge species&#39;)+ylab(&#39;OTU count&#39;)+ theme(axis.text.x = # element_text(angle = 90, hjust = 1)) # perc &lt;- ggplot(plot, aes(x=response, y=value, fill=variable)) + # geom_bar(position=&#39;fill&#39;, stat=&#39;identity&#39;)+ # theme_minimal()+ggtitle(&#39;Percentages&#39;)+xlab(&#39;Sponge species&#39;)+ylab(&#39;relative # OTU count&#39;)+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) # grid.arrange(stacked, perc, nrow=2) write.csv(gb_response, &#39;gb_response.csv&#39;) # write.csv(sf_response, &#39;sf_response.csv&#39;) write.csv(wb_response, # &#39;wb_response.csv&#39;) In this Fig.3.10 as well as in Tab. 3.4, we see that at the OTU level, we observe shifts. While sometimes more gradual, there seem to OTUs exclusievely present in the “shallow” or the “deep” samples in all three sponges. In fact, in G. barretti and S. fortis, the number of OTUs increasing with depth (“deep water mass microbiome”) is greater than the number of OTUs decreasing. This leads us to believe that the deep water mass contains microbes yet to discover. 3.7 Sequence similarity We produced fasta files, i.e. files containing the DNA sequences of the OTUs in the three sponges. The fasta header contains the following information: “OTU number”_“depth response”_“phylum”_“class”. The depth response is coded as “increasing” or “decreasing” if there is a significant correlation (p\\(\\leq\\) 0.05) with depth and as “inc. trend” or “dec. trend” if the correlation is not significant (p\\(\\geq\\) 0.05). The fasta sequences were aligned with MAFFT. From the aligned seqeunces, we calculated the sequence similarity comparing all versus all, and retain in a file all comparisons yielding a sequence similarity \\(\\geq\\) 97%. # Load one file at a time ali &lt;- read.alignment(&quot;data/gb_reads_for_phylogeny_MAFFT.fasta&quot;, &quot;fasta&quot;) ali &lt;- read.alignment(&quot;data/sf_reads_for_phylogeny_MAFFT.fasta&quot;, &quot;fasta&quot;) ali &lt;- read.alignment(&quot;data/wb_reads_for_phylogeny_MAFFT.fasta&quot;, &quot;fasta&quot;) # FUN calculate pairwise distance, melt, keeps only entries with &gt;97% and &lt;1 # similarity with significant opposing trends in both partners. pw_dist &lt;- function(ali) { dist &lt;- as.matrix(dist.alignment(ali, matrix = &quot;similarity&quot;)) #https://www.researchgate.net/post/Homology_similarity_and_identity-can_anyone_help_with_these_terms # dist.alignment: matrix contains the squared root of the pairwise distances. For # example, if identity between 2 sequences is 80 the squared root of (1.0 - 0.8) # i.e. 0.4472136. dist &lt;- dist^2 dist &lt;- 1 - dist # dist is now &#39;%&#39; identity, 1=100 % dist &lt;- melt(dist) # Remove irrelevant entries, i.e. self-comparison and similarities below the # threshold, this step now speeds up later steps, but not mandatory dist &lt;- dist[dist$value &gt;= 0.97, ] dist &lt;- dist[!dist$value == 1, ] # This removes AB - BA duplicates but still contains self comprisons, AA, BB,CC # etc. cols &lt;- c(&quot;Var1&quot;, &quot;Var2&quot;) newdf &lt;- dist[, cols] for (i in 1:nrow(newdf)) { newdf[i, ] = sort(newdf[i, cols]) } newdf &lt;- newdf[!duplicated(newdf), ] # add back similarity values to the remaining comparisons/pairs dist &lt;- left_join(newdf, dist, by = c(Var1 = &quot;Var1&quot;, Var2 = &quot;Var2&quot;)) dist[&quot;Var1_response&quot;] &lt;- str_sub(dist$Var1, 5, 10) dist[&quot;Var2_response&quot;] &lt;- str_sub(dist$Var2, 5, 10) # remove not significant comparisons dist &lt;- dist[!dist$Var1_response == &quot;dec.tr&quot;, ] # can be toggled off dist &lt;- dist[!dist$Var1_response == &quot;inc.tr&quot;, ] # can be toggled off dist &lt;- dist[!dist$Var2_response == &quot;dec.tr&quot;, ] # can be toggled off dist &lt;- dist[!dist$Var2_response == &quot;inc.tr&quot;, ] # can be toggled off dist &lt;- dist[!dist$Var2_response == dist$Var1_response, ] # order dist &lt;- dist[order(dist$Var1_response, dist$Var2_response), ] return(dist) } dist &lt;- pw_dist(ali) dist # create csv file write.csv(dist, &quot;~/Documents/Metabolomics/Depth_Gradient_study/R_depth_study/Phylogeny/gb_similarity.csv&quot;) # GB write.csv(dist, &quot;~/Documents/Metabolomics/Depth_Gradient_study/R_depth_study/Phylogeny/sf_similarity.csv&quot;) # SF write.csv(dist, &quot;~/Documents/Metabolomics/Depth_Gradient_study/R_depth_study/Phylogeny/wb_similarity.csv&quot;) # WB In G. barretti there are 34 pairs of OTUs with a sequence similarity \\(\\geq\\) 97% and opposing responses to depth, in S. fortis there are 11 pairs while in W. bursa, there are none. 3.8 Phylogeny The MAFFT aligend fasta sequences of G. barretti OTUs were used to infer a phylogeny under maximum likelihood model in RaxML/Bayesian statistics. # ====================== OCCURRENCE ============== REL ABDC On original data # sets, NOT SQRT transformed (Y tho?) micros is sqrt transformed micro_ds &lt;- OTU_prep_sqrt(micro) # RUN occurrence gb_occurrence &lt;- overall_rabdc((micro_ds$gb**2)) #INDRA&#39;s way # exponentiate (**2) to reverse sqrt sf_occurrence &lt;- # overall_rabdc((micro_ds$sf**2)) wb_occurrence &lt;- # overall_rabdc((micro_ds$wb**2)) gb_occurrence &lt;- overall_rabdc(micro_ds$gb) sf_occurrence &lt;- overall_rabdc(micro_ds$sf) wb_occurrence &lt;- overall_rabdc(micro_ds$wb) # only file dump write.csv(gb_occurrence, &#39;gb_occurrence_avg_rel_abdc_OTU.csv&#39;) # write.csv(sf_occurrence, &#39;sf_occurrence_avg_rel_abdc_OTU.csv&#39;) # write.csv(wb_occurrence, &#39;wb_occurrence_avg_rel_abdc_OTU.csv&#39;) aggregate(gb_occurrence, by = list(gb_occurrence$occurrence), FUN = &quot;length&quot;) aggregate(sf_occurrence, by = list(sf_occurrence$occurrence), FUN = &quot;length&quot;) aggregate(wb_occurrence, by = list(wb_occurrence$occurrence), FUN = &quot;length&quot;) # combined file dump gb_occurrence[&#39;XOTU&#39;] &lt;- rownames(gb_occurrence) # sf_occurrence[&#39;XOTU&#39;] &lt;- rownames(sf_occurrence) wb_occurrence[&#39;XOTU&#39;] &lt;- # rownames(wb_occurrence) gb_data &lt;- full_join(gb_response, # gb_occurrence[,c(&#39;XOTU&#39;, &#39;avg_rel_abdc&#39;, &#39;occurrence&#39;)]) sf_data &lt;- # full_join(sf_response, sf_occurrence[,c(&#39;XOTU&#39;, &#39;avg_rel_abdc&#39;, &#39;occurrence&#39;)]) # wb_data &lt;- full_join(wb_response, wb_occurrence[,c(&#39;XOTU&#39;, &#39;avg_rel_abdc&#39;, # &#39;occurrence&#39;)]) taxonomy[&#39;dummy&#39;] &lt;- c(&#39;X&#39;) taxonomy[&#39;XOTU&#39;] &lt;- # str_c(taxonomy$dummy, taxonomy$OTU_ID) taxonomy$dummy &lt;- NULL gb_data &lt;- # left_join(gb_data, taxonomy) sf_data &lt;- left_join(sf_data, taxonomy) wb_data &lt;- # left_join(wb_data, taxonomy) write.csv(gb_data, &#39;gb_data.csv&#39;) # write.csv(sf_data, &#39;sf_data.csv&#39;) write.csv(wb_data, &#39;wb_data.csv&#39;) # quick_comparison gb_occurrence &lt;- gb_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] sf_occurrence &lt;- sf_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] wb_occurrence &lt;- wb_occurrence[, c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;)] colnames(gb_occurrence) &lt;- c(&quot;gb.avg_rabdc&quot;, &quot;gb.occurr&quot;) colnames(sf_occurrence) &lt;- c(&quot;sf.avg_rabdc&quot;, &quot;sf.occurr&quot;) colnames(wb_occurrence) &lt;- c(&quot;wb.avg_rabdc&quot;, &quot;wb.occurr&quot;) gb_occurrence[&quot;XOTU&quot;] &lt;- rownames(gb_occurrence) sf_occurrence[&quot;XOTU&quot;] &lt;- rownames(sf_occurrence) wb_occurrence[&quot;XOTU&quot;] &lt;- rownames(wb_occurrence) aggregate(gb_occurrence, by = list(gb_occurrence$gb.occurr), FUN = &quot;length&quot;) aggregate(sf_occurrence, by = list(sf_occurrence$sf.occurr), FUN = &quot;length&quot;) aggregate(wb_occurrence, by = list(wb_occurrence$wb.occurr), FUN = &quot;length&quot;) occurrence_sqrt &lt;- full_join(gb_occurrence, sf_occurrence) occurrence_sqrt &lt;- full_join(occurrence_sqrt, wb_occurrence) head(occurrence_sqrt) occurrence_exp.raw &lt;- full_join(gb_occurrence, sf_occurrence) occurrence_exp.raw &lt;- full_join(occurrence_exp.raw, wb_occurrence) head(occurrence_exp.raw) # ====================== overview phylum class ========== For figures (OTU # relative abdc heatmaps), and inc-dec correlations. Requires OTU_prep_sqrt. micro_ds &lt;- OTU_prep_sqrt(micro) # RUN calculate relative abundance of OTU across sponge samples gb_occurrence &lt;- overall_rabdc(micro_ds$gb) sf_occurrence &lt;- overall_rabdc(micro_ds$sf) wb_occurrence &lt;- overall_rabdc(micro_ds$wb) occurrence &lt;- list(gb = gb_occurrence, sf = sf_occurrence, wb = wb_occurrence) taxes &lt;- aggregations(taxonomy, occurrence) taxes &lt;- cleaning(taxes) phy_OTU &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;length&quot;)) #OTU count phy_rabdc &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Phylum, data = x, FUN = &quot;sum&quot;)) #sums relative abundance class_OTU &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Class, data = x, FUN = &quot;length&quot;)) class_rabdc &lt;- lapply(taxes, function(x) aggregate(avg_rel_abdc ~ Class, data = x, FUN = &quot;sum&quot;)) # all collected in Excel file. Done. Microbiome_aggregation_phylum_class.xlsx , # in &#39;/writing/&#39;. # Statistic comparison based on averages of relative abundance of phyla and # classes CLASS class &lt;- full_join(class_rabdc$gb, class_rabdc$sf, by = c(&quot;Class&quot;)) class &lt;- full_join(class, class_rabdc$wb, by = c(&quot;Class&quot;)) colnames(class) &lt;- c(&quot;Class&quot;, &quot;gb_avg&quot;, &quot;sf_avg&quot;, &quot;wb_avg&quot;) class$gb_avg[is.na(class$gb_avg)] &lt;- 0 class$sf_avg[is.na(class$sf_avg)] &lt;- 0 class$wb_avg[is.na(class$wb_avg)] &lt;- 0 head(class) kruskal.test(class[, c(2:4)]) #p-value = 3.364e-05 # all three kruskal.test(class[, c(2:3)]) #p-value = 0.6594 # gb &amp; sf # PHYLUM phylum &lt;- full_join(phy_rabdc$gb, phy_rabdc$sf, by = c(&quot;Phylum&quot;)) phylum &lt;- full_join(phylum, phy_rabdc$wb, by = c(&quot;Phylum&quot;)) colnames(phylum) &lt;- c(&quot;Phylum&quot;, &quot;gb_avg&quot;, &quot;sf_avg&quot;, &quot;wb_avg&quot;) phylum$gb_avg[is.na(phylum$gb_avg)] &lt;- 0 phylum$sf_avg[is.na(phylum$sf_avg)] &lt;- 0 phylum$wb_avg[is.na(phylum$wb_avg)] &lt;- 0 head(phylum) kruskal.test(phylum[, c(2:4)]) #p-value = 0.2915 # all three kruskal.test(phylum[, c(2:3)]) #p-value = 0.5102 # gb &amp; sf # ======================= Testing differences at phylum and class level # =========== micro_ds &lt;- OTU_prep_sqrt(micro) occurrence &lt;- lapply(micro_ds, overall_rabdc) # PHYLUM taxes &lt;- adonis_prep(taxonomy, occurrence) taxes &lt;- cleaning(taxes) taxes &lt;- lapply(taxes, function(x) { rownames(x) &lt;- x$XOTU x }) taxes &lt;- lapply(taxes, function(x) { x[c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;, &quot;OTU_ID&quot;, &quot;XOTU&quot;)] &lt;- NULL x }) taxes &lt;- lapply(taxes, function(x) { x[&quot;Class&quot;] &lt;- NULL x }) head(taxes) gb &lt;- aggregate(taxes$gb[, 2:dim(taxes$gb)[2]], list(taxes$gb[, &quot;Phylum&quot;]), sum) #works sf &lt;- aggregate(taxes$sf[, 2:dim(taxes$sf)[2]], list(taxes$sf[, &quot;Phylum&quot;]), sum) #works wb &lt;- aggregate(taxes$wb[, 2:dim(taxes$wb)[2]], list(taxes$wb[, &quot;Phylum&quot;]), sum) #works # for this to work, dono&#39;t run: taxes &lt;- lapply(taxes, function(x) {x[&#39;Class&#39;] &lt;- # NULL; x}) gb &lt;- aggregate(taxes$gb[,3:dim(taxes$gb)[2]], # list(taxes$gb[,&#39;Phylum&#39;], taxes$gb[,&#39;Class&#39;]), sum) #works sf &lt;- # aggregate(taxes$sf[,3:dim(taxes$sf)[2]], list(taxes$sf[,&#39;Phylum&#39;], # taxes$sf[,&#39;Class&#39;]), sum) #works wb &lt;- aggregate(taxes$wb[,3:dim(taxes$wb)[2]], # list(taxes$wb[,&#39;Phylum&#39;], taxes$wb[,&#39;Class&#39;]), sum) #works taxes_phy &lt;- full_join(gb, sf) taxes_phy &lt;- full_join(taxes_phy, wb) taxes_phy[is.na(taxes_phy)] &lt;- 0 head(taxes_phy) # check there are no weird names aggregate(.~ Group.1, data=taxes_phy, sum) rownames(taxes_phy) &lt;- taxes_phy$Group.1 taxes_phy$Group.1 &lt;- NULL taxes_phy_t &lt;- data.frame(t(taxes_phy)) specs &lt;- data.frame(rownames(taxes_phy_t)) colnames(specs) &lt;- c(&quot;Sample_ID&quot;) specs[&quot;species&quot;] &lt;- str_sub(specs$Sample_ID, 1, 2) # Permutational anova adonis(taxes_phy_t ~ specs$species) #all three species //significant adonis(taxes_phy_t[c(1:29), ] ~ specs[c(1:29), 2]) #only Gb and Sf //significant # Compare variation of relative abundance of each phylum/class among/within the # two/three groups ANOVA (three groups) apply(taxes_phy_t, 2, function(x) { summary(aov(x ~ specs$species)) }) # of course they&#39;re all different, this includes Weberella. # Mann-Whittney U aka Wilcoxon rank sum test(two groups, gb vs sf) gbsf_phy &lt;- taxes_phy_t[c(1:29), ] gbsf_spec &lt;- specs[c(1:29), ] apply(gbsf_phy, 2, function(x) { wilcox.test(x ~ gbsf_spec$species) }) apply(gbsf_phy, 2, function(x) { (wilcox.test(x ~ gbsf_spec$species))[&quot;p.value&quot;] }) #This is really the result we want # CLASS micro_ds &lt;- OTU_prep_sqrt(micro) occurrence &lt;- lapply(micro_ds, overall_rabdc) taxes &lt;- adonis_prep(taxonomy, occurrence) taxes &lt;- cleaning(taxes) taxes &lt;- lapply(taxes, function(x) { rownames(x) &lt;- x$XOTU x }) taxes &lt;- lapply(taxes, function(x) { x[c(&quot;avg_rel_abdc&quot;, &quot;occurrence&quot;, &quot;OTU_ID&quot;, &quot;XOTU&quot;)] &lt;- NULL x }) # ================out=================== gb &lt;- taxes$gb sf &lt;- taxes$sf wb &lt;- # taxes$wb Renaming &amp; removing whitespaces gb$Phylum &lt;- # as.character(str_trim(as.character(gb$Phylum))) sf$Phylum &lt;- # as.character(str_trim(as.character(sf$Phylum))) wb$Phylum &lt;- # as.character(str_trim(as.character(wb$Phylum))) gb$Class &lt;- # as.character(str_trim(as.character(gb$Class))) sf$Class &lt;- # as.character(str_trim(as.character(sf$Class))) wb$Class &lt;- # as.character(str_trim(as.character(wb$Class))) GB # gb$Class[(gb$Phylum==&#39;PAUC34f&#39;)] &lt;- &#39;PAUC34f_unclassified&#39; # gb$Class[(gb$Phylum==&#39;&#39;)] &lt;- &#39;unclassified&#39; gb$Phylum[(gb$Phylum==&#39;&#39;)] &lt;- # &#39;unclassified&#39; gb$Class[(gb$Phylum==&#39;Tectomicrobia&#39;)] &lt;- # &#39;Tectomicrobia_unclassified&#39; gb$Class[(gb$Phylum==&#39;SBR1093&#39;)] &lt;- # &#39;SBR1093_unclassified&#39; gb$Class[(gb$Phylum==&#39;Poribacteria&#39;)] &lt;- # &#39;Poribacteria_unclassified&#39; gb$Class[gb$Phylum==&#39;Chloroflexi&#39; &amp; gb$Class==&#39;&#39;] # &lt;- &#39;Chloroflexi_unclassified&#39; SF sf$Class[(sf$Phylum==&#39;&#39;)] &lt;- &#39;unclassified&#39; # sf$Phylum[(sf$Phylum==&#39;&#39;)] &lt;- &#39;unclassified&#39; sf$Class[(sf$Phylum==&#39;PAUC34f&#39;)] # &lt;- &#39;PAUC34f_unclassified&#39; sf$Class[(sf$Phylum==&#39;Proteobacteria&#39; &amp; # sf$Class==&#39;&#39;)] &lt;- &#39;Proteobacteria_unclassified&#39; # sf$Class[(sf$Phylum==&#39;Tectomicrobia&#39;)] &lt;- &#39;Tectomicrobia_unclassified&#39; # sf$Class[(sf$Phylum==&#39;SBR1093&#39;)] &lt;- &#39;SBR1093_unclassified&#39; # sf$Class[(sf$Phylum==&#39;Poribacteria&#39;)] &lt;- &#39;Poribacteria_unclassified&#39; WB # wb$Class[(wb$Phylum==&#39;&#39;)] &lt;- &#39;unclassified&#39; wb$Phylum[(wb$Phylum==&#39;&#39;)] &lt;- # &#39;unclassified&#39; merge back taxes &lt;- list(gb=gb, sf=sf, wb=wb) # ========================================= taxes &lt;- lapply(taxes, function(x) { x[&quot;Phylum&quot;] &lt;- NULL x }) head(taxes) gb &lt;- aggregate(taxes$gb[, 2:dim(taxes$gb)[2]], list(taxes$gb[, &quot;Class&quot;]), sum) #works sf &lt;- aggregate(taxes$sf[, 2:dim(taxes$sf)[2]], list(taxes$sf[, &quot;Class&quot;]), sum) #works wb &lt;- aggregate(taxes$wb[, 2:dim(taxes$wb)[2]], list(taxes$wb[, &quot;Class&quot;]), sum) #works taxes_cla &lt;- full_join(gb, sf) taxes_cla &lt;- full_join(taxes_cla, wb) taxes_cla[is.na(taxes_cla)] &lt;- 0 head(taxes_cla) # check there are no weird names aggregate(.~ Group.1, data=taxes_cla, sum) rownames(taxes_cla) &lt;- taxes_cla$Group.1 taxes_cla$Group.1 &lt;- NULL taxes_cla_t &lt;- data.frame(t(taxes_cla)) specs &lt;- data.frame(rownames(taxes_cla_t)) colnames(specs) &lt;- c(&quot;Sample_ID&quot;) specs[&quot;species&quot;] &lt;- str_sub(specs$Sample_ID, 1, 2) # Permutational anova adonis(taxes_cla_t ~ specs$species) #all three species //significant adonis(taxes_cla_t[c(1:29), ] ~ specs[c(1:29), 2]) #only Gb and Sf //significant # Compare variation of relative abundance of each clalum/class among/within the # two/three groups ANOVA (three groups) apply(taxes_cla_t, 2, function(x) { summary(aov(x ~ specs$species)) }) # of course they&#39;re all different, this includes Weberella. # Mann-Whittney U aka Wilcoxon rank sum test(two groups, gb vs sf) gbsf_cla &lt;- taxes_cla_t[c(1:29), ] gbsf_spec &lt;- specs[c(1:29), ] apply(gbsf_cla, 2, function(x) { wilcox.test(x ~ gbsf_spec$species) }) apply(gbsf_cla, 2, function(x) { (wilcox.test(x ~ gbsf_spec$species))[&quot;p.value&quot;] }) ### =========================================== For plotting ### ================================ # YAS! taxes_phy_m &lt;- taxes_phy_t taxes_phy_m[&quot;Sample_ID&quot;] &lt;- rownames(taxes_phy_m) taxes_phy_m &lt;- melt(taxes_phy_m, id.vars = c(&quot;Sample_ID&quot;)) taxes_phy_m[&quot;Phylum&quot;] &lt;- taxes_phy_m$variable # taxes_phy_m$Phylum[taxes_phy_m$Phylum==&#39;classified&#39;] &lt;- &#39;unclassified&#39; taxes_phy_m unique(taxes_phy_m$Phylum) library(RColorBrewer) phylum_palette &lt;- c(&quot;#b8c4f6&quot;, &quot;#ffaaaf&quot;, &quot;#3d1349&quot;, &quot;#ffffff&quot;, &quot;#01559d&quot;, &quot;#ffffff&quot;, &quot;#ffffff&quot;, &quot;#ffffff&quot;, &quot;#ffffff&quot;, &quot;#019c51&quot;, &quot;#b10060&quot;, &quot;#49ca00&quot;, &quot;#dd8e00&quot;, &quot;#f282ff&quot;, &quot;#ffffff&quot;, &quot;#ff633f&quot;, &quot;#ec0040&quot;, &quot;#010b92&quot;, &quot;#cf00aa&quot;, &quot;#aba900&quot;, &quot;#ffffff&quot;, &quot;#fce300&quot;) ggplot(taxes_phy_m, aes(x = Sample_ID, y = value, fill = Phylum)) + geom_bar(stat = &quot;identity&quot;) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) last_plot() + scale_x_discrete(limits = c(&quot;Gb1&quot;, &quot;Gb2&quot;, &quot;Gb3&quot;, &quot;Gb4&quot;, &quot;Gb5&quot;, &quot;Gb6&quot;, &quot;Gb7&quot;, &quot;Gb8&quot;, &quot;Gb9&quot;, &quot;Gb10&quot;, &quot;Gb11&quot;, &quot;Gb12&quot;, &quot;Gb13&quot;, &quot;Gb14&quot;, &quot;Sf1&quot;, &quot;Sf2&quot;, &quot;Sf3&quot;, &quot;Sf4&quot;, &quot;Sf5&quot;, &quot;Sf6&quot;, &quot;Sf7&quot;, &quot;Sf8&quot;, &quot;Sf9&quot;, &quot;Sf10&quot;, &quot;Sf11&quot;, &quot;Sf12&quot;, &quot;Sf13&quot;, &quot;Sf14&quot;, &quot;Sf15&quot;, &quot;Wb1&quot;, &quot;Wb2&quot;, &quot;Wb3&quot;, &quot;Wb4&quot;, &quot;Wb5&quot;, &quot;Wb6&quot;, &quot;Wb7&quot;, &quot;Wb8&quot;, &quot;Wb9&quot;, &quot;Wb10&quot;, &quot;Wb11&quot;, &quot;Wb12&quot;, &quot;Wb13&quot;, &quot;Wb14&quot;, &quot;Wb15&quot;, &quot;Wb16&quot;)) + xlab(&quot;Samples ordered by depth&quot;) + ylab(&quot;Relative abundance&quot;) + scale_fill_manual(values = phylum_palette) # ======END================================= ### ===== For Venn diagramms ============================= micro_ds &lt;- OTU_prep_sqrt(micro) gb_otus &lt;- as.data.frame(colnames(micro_ds$gb)) colnames(gb_otus) &lt;- c(&quot;XOTU&quot;) sf_otus &lt;- as.data.frame(colnames(micro_ds$sf)) colnames(sf_otus) &lt;- c(&quot;XOTU&quot;) wb_otus &lt;- as.data.frame(colnames(micro_ds$wb)) colnames(wb_otus) &lt;- c(&quot;XOTU&quot;) dim(intersect(gb_otus, sf_otus))[1] # 361 dim(intersect(gb_otus, wb_otus))[1] # 2 dim(intersect(sf_otus, wb_otus))[1] # 8 length(intersect(intersect(gb_otus, wb_otus), intersect(sf_otus, wb_otus))) # 1 # ========================================================== # levels(taxes_phy$Group.1)[1] &lt;- &#39;unclassified&#39; ### old stuff , could be deleted I belive=========== tax_gb &lt;- inner_join(tax, gb_occurrence[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) tax_sf &lt;- inner_join(tax, sf_occurrence[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) tax_wb &lt;- inner_join(tax, wb_occurrence[, c(&quot;XOTU&quot;, &quot;avg_rel_abdc&quot;)]) gb1 &lt;- aggregate(tax_gb$Phylum, by = list(tax_gb$Phylum), FUN = &quot;length&quot;) gb2 &lt;- aggregate(tax_gb$avg_rel_abdc, by = list(tax_gb$Phylum), FUN = &quot;sum&quot;) gb_p &lt;- full_join(gb1, gb2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(gb_p) &lt;- c(&quot;Phylum&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) gb1 &lt;- aggregate(tax_gb$Class, by = list(tax_gb$Class), FUN = &quot;length&quot;) gb2 &lt;- aggregate(tax_gb$avg_rel_abdc, by = list(tax_gb$Class), FUN = &quot;sum&quot;) gb_c &lt;- full_join(gb1, gb2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(gb_c) &lt;- c(&quot;Class&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) sf1 &lt;- aggregate(tax_sf$Phylum, by = list(tax_sf$Phylum), FUN = &quot;length&quot;) sf2 &lt;- aggregate(tax_sf$avg_rel_abdc, by = list(tax_sf$Phylum), FUN = &quot;sum&quot;) sf_p &lt;- full_join(sf1, sf2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(sf_p) &lt;- c(&quot;Phylum&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) sf1 &lt;- aggregate(tax_sf$Class, by = list(tax_sf$Class), FUN = &quot;length&quot;) sf2 &lt;- aggregate(tax_sf$avg_rel_abdc, by = list(tax_sf$Class), FUN = &quot;sum&quot;) sf_c &lt;- full_join(sf1, sf2, by = (&quot;Group.1&quot; = &quot;Group.1&quot;)) colnames(sf_c) &lt;- c(&quot;Class&quot;, &quot;OTU_number&quot;, &quot;avg_rel_abdc&quot;) References "]
]
